<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏùµÎ™Ö Í≤åÏãúÌåê</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f7fa; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; padding: 20px; background: white; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); flex-wrap: wrap; }
        .tab { flex: 1; min-width: 80px; padding: 12px; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; background: #f5f7fa; color: #7f8c8d; transition: all 0.3s; }
        .tab.active { background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: white; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input, textarea, select { width: 100%; padding: 12px; border: 2px solid #e8e8e8; border-radius: 8px; font-size: 1rem; margin-bottom: 10px; font-family: inherit; }
        textarea { min-height: 100px; resize: vertical; }
        .btn { width: 100%; padding: 14px; background: #4a90e2; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .btn:hover { background: #357abd; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-small { width: auto; padding: 8px 15px; font-size: 0.9rem; }
        .post { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .post-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; color: #666; }
        .post-footer { display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0; }
        .reaction { padding: 8px 12px; background: #f8f9fa; border: 1px solid #e8e8e8; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
        .reaction:hover { background: #e8ecef; }
        .comments { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .comment { background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        .comment-header { font-size: 0.85rem; color: #666; margin-bottom: 5px; }
        .comment-input { display: flex; gap: 10px; margin-top: 10px; }
        .chat-container { height: 500px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .chat-message { background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        .chat-header { font-weight: bold; color: #4a90e2; margin-bottom: 5px; font-size: 0.9rem; }
        .detector-result { padding: 30px; border-radius: 12px; margin: 20px 0; text-align: center; animation: fadeIn 0.5s; }
        .detector-result.true { background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); color: white; }
        .detector-result.false { background: linear-gradient(135deg, #f44336 0%, #ef5350 100%); color: white; }
        .pvp-result { padding: 30px; border-radius: 12px; text-align: center; margin-bottom: 20px; color: white; animation: fadeIn 0.5s; }
        .pvp-result.win { background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); }
        .pvp-result.lose { background: linear-gradient(135deg, #f44336 0%, #ef5350 100%); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        /* ÎßàÌîºÏïÑ Í≤åÏûÑ Ïä§ÌÉÄÏùº */
        .mafia-room-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .mafia-room-card { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .mafia-room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        .mafia-room-header { font-size: 1.3rem; font-weight: bold; margin-bottom: 10px; }
        .mafia-room-info { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 0.9rem;
        }
        .mafia-player-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 12px; 
            margin: 20px 0;
        }
        .mafia-player-card { 
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e8e8e8;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        .mafia-player-card:hover { background: #e8ecef; border-color: #4a90e2; }
        .mafia-player-card.dead { opacity: 0.5; background: #ddd; }
        .mafia-player-card.selected { border-color: #e74c3c; background: #ffe6e6; }
        .mafia-player-card.me { border-color: #2ecc71; background: #e8f8f5; }
        .mafia-role-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-top: 8px;
        }
        .role-mafia { background: #e74c3c; color: white; }
        .role-citizen { background: #3498db; color: white; }
        .role-doctor { background: #2ecc71; color: white; }
        .role-police { background: #f39c12; color: white; }
        .mafia-phase {
            text-align: center;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 1.8rem;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        .phase-day { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; }
        .phase-night { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; }
        .phase-vote { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; }
        .phase-waiting { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        .mafia-timer {
            text-align: center;
            font-size: 3rem;
            font-weight: bold;
            color: #e74c3c;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }
        .mafia-chat {
            height: 350px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #e8e8e8;
        }
        .mafia-message {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #4a90e2;
        }
        .mafia-message.system { background: #fff3cd; border-left-color: #f39c12; font-style: italic; }
        .mafia-message.private { background: #d4edda; border-left-color: #28a745; }
        .mafia-message-header {
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        .mafia-result {
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            margin: 30px 0;
            animation: fadeIn 0.5s;
            color: white;
        }
        .result-mafia-win { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .result-citizen-win { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .mafia-rules {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #4a90e2;
        }
        .mafia-rules h3 { color: #2c3e50; margin-bottom: 15px; font-size: 1.3rem; }
        .mafia-rules p { line-height: 1.8; color: #34495e; margin-bottom: 10px; }
        .mafia-rules ul { list-style: none; padding-left: 0; }
        .mafia-rules li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }
        .mafia-rules li:before {
            content: "‚ñ™";
            position: absolute;
            left: 0;
            color: #4a90e2;
            font-weight: bold;
        }
        .info-box { background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .warning-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .danger-box { background: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .kick-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .kick-btn:hover { background: #c0392b; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyDh3FsyWVZqy8wGExv-IlAglJ0DERuW_T8",
            authDomain: "ccccc-74256.firebaseapp.com",
            databaseURL: "https://ccccc-74256-default-rtdb.firebaseio.com",
            projectId: "ccccc-74256",
            storageBucket: "ccccc-74256.firebasestorage.app",
            messagingSenderId: "1086870817114",
            appId: "1:1086870817114:web:8fb533c96f3402bfe78b63"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        
        // ÎßàÌîºÏïÑ Í≤åÏûÑ ÏÉÅÏàò (Ï†ÑÏó≠)
        const MAFIA_ROLES = {
            MAFIA: { name: 'ÎßàÌîºÏïÑ', emoji: 'üî™', color: 'role-mafia', description: 'Î∞§Ïóê ÏãúÎØºÏùÑ Ï†úÍ±∞Ìï©ÎãàÎã§' },
            CITIZEN: { name: 'ÏãúÎØº', emoji: 'üë§', color: 'role-citizen', description: 'ÌÜ†Î°†Í≥º Ìà¨ÌëúÎ°ú ÎßàÌîºÏïÑÎ•º Ï∞æÏïÑÎÉÖÎãàÎã§' },
            DOCTOR: { name: 'ÏùòÏÇ¨', emoji: '‚öïÔ∏è', color: 'role-doctor', description: 'Î∞§Ïóê Ìïú Î™ÖÏùÑ ÎßàÌîºÏïÑÎ°úÎ∂ÄÌÑ∞ Î≥¥Ìò∏Ìï©ÎãàÎã§' },
            POLICE: { name: 'Í≤ΩÏ∞∞', emoji: 'üëÆ', color: 'role-police', description: 'Î∞§Ïóê Ìïú Î™ÖÏùÑ Ï°∞ÏÇ¨ÌïòÏó¨ ÎßàÌîºÏïÑ Ïó¨Î∂ÄÎ•º ÌôïÏù∏Ìï©ÎãàÎã§' }
        };
        const MAFIA_PHASES = { WAITING: 'waiting', DAY: 'day', VOTE: 'vote', NIGHT: 'night' };

        function App() {
            const [tab, setTab] = useState('board');
            
            // Í≤åÏãúÌåê
            const [posts, setPosts] = useState([]);
            const [postTitle, setPostTitle] = useState('');
            const [postContent, setPostContent] = useState('');
            const [postAuthor, setPostAuthor] = useState('');
            const [myAnonymousId, setMyAnonymousId] = useState('');
            const [commentInputs, setCommentInputs] = useState({});
            
            // Ï±ÑÌåÖ
            const [messages, setMessages] = useState([]);
            const [chatMsg, setChatMsg] = useState('');
            const [chatNick, setChatNick] = useState('');
            const chatRef = useRef(null);
            
            // Í±∞ÏßìÎßêÌÉêÏßÄÍ∏∞
            const [detectorQuestion, setDetectorQuestion] = useState('');
            const [detectorResult, setDetectorResult] = useState(null);
            const [detectorLoading, setDetectorLoading] = useState(false);
            
            // Ìà¨Ìëú
            const [polls, setPolls] = useState([]);
            const [pollQuestion, setPollQuestion] = useState('');
            const [pollOptions, setPollOptions] = useState(['', '']);
            const [myVotes, setMyVotes] = useState({});
            
            // ÎÜçÏû•
            const [farmUser, setFarmUser] = useState(null);
            const [farmNick, setFarmNick] = useState('');
            const [farmPass, setFarmPass] = useState('');
            const [isLogin, setIsLogin] = useState(true);
            const [allUsers, setAllUsers] = useState([]);
            const [timer, setTimer] = useState('');
            const [pvpTarget, setPvpTarget] = useState('');
            const [pvpAmount, setPvpAmount] = useState('');
            const [pvpReqs, setPvpReqs] = useState([]);
            const [pvpResult, setPvpResult] = useState(null);
            const [showRules, setShowRules] = useState(false);
            
            // Í∞ïÌôî
            const [forgeResult, setForgeResult] = useState(null);
            const [forging, setForging] = useState(false);
            
            // ÎßàÌîºÏïÑ Í≤åÏûÑ
            const [mafiaScreen, setMafiaScreen] = useState('lobby');
            const [mafiaRooms, setMafiaRooms] = useState({});
            const [currentMafiaRoom, setCurrentMafiaRoom] = useState(null);
            const [mafiaMessages, setMafiaMessages] = useState([]);
            const [mafiaChatInput, setMafiaChatInput] = useState('');
            const [mafiaSelectedPlayer, setMafiaSelectedPlayer] = useState('');
            const [mafiaTimeLeft, setMafiaTimeLeft] = useState(0);
            const [myMafiaId, setMyMafiaId] = useState('');
            const [myMafiaNick, setMyMafiaNick] = useState('');
            const [newMafiaRoomName, setNewMafiaRoomName] = useState('');
            const [newMafiaRoomMax, setNewMafiaRoomMax] = useState(8);
            const [showMafiaRules, setShowMafiaRules] = useState(false);
            const mafiaChatRef = useRef(null);

            // ÏùµÎ™Ö ID ÏÉùÏÑ±
            useEffect(() => {
                let id = localStorage.getItem('anonymousId');
                if (!id) {
                    id = 'anon_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('anonymousId', id);
                }
                setMyAnonymousId(id);
            }, []);

            // Í≤åÏãúÌåê Î°úÎìú
            useEffect(() => {
                db.ref('posts').limitToLast(50).on('value', snap => {
                    const data = snap.val();
                    if (data) {
                        const arr = Object.keys(data).map(k => ({id: k, ...data[k]})).sort((a,b) => b.timestamp - a.timestamp);
                        setPosts(arr);
                    } else {
                        setPosts([]);
                    }
                });
            }, []);

            // Ï±ÑÌåÖ Î°úÎìú
            useEffect(() => {
                db.ref('chatMessages').limitToLast(100).on('value', snap => {
                    const data = snap.val();
                    if (data) {
                        const arr = Object.keys(data).map(k => ({id: k, ...data[k]})).sort((a,b) => a.timestamp - b.timestamp);
                        setMessages(arr);
                    }
                });
            }, []);
            
            // Ï±ÑÌåÖ ÏûêÎèô Ïä§ÌÅ¨Î°§
            useEffect(() => {
                if (chatRef.current && messages.length > 0) {
                    chatRef.current.scrollTop = chatRef.current.scrollHeight;
                }
            }, [messages]);
            
            // ÌÉ≠ Î≥ÄÍ≤Ω Ïãú Ï±ÑÌåÖ Ïä§ÌÅ¨Î°§
            useEffect(() => {
                if (tab === 'chat' && chatRef.current) {
                    setTimeout(() => {
                        if (chatRef.current) {
                            chatRef.current.scrollTop = chatRef.current.scrollHeight;
                        }
                    }, 100);
                }
            }, [tab]);

            // Ï±ÑÌåÖ ÎãâÎÑ§ÏûÑ
            useEffect(() => {
                let nick = localStorage.getItem('chatRandomNickname');
                if (!nick) {
                    const names = ['ÏùÑÏõÖ', 'Î™ÖÏßÑ', 'ÎØºÏàò', 'Ï∂©Ïó∞', 'ÎØºÍ∏∞', 'ÎØºÌò∏', 'Ïã†Ïö∞', 'ÎåÄÏõÖ'];
                    nick = names[Math.floor(Math.random() * names.length)];
                    localStorage.setItem('chatRandomNickname', nick);
                }
                setChatNick(nick);
            }, []);

            // Ìà¨Ìëú Î°úÎìú
            useEffect(() => {
                db.ref('polls').on('value', snap => {
                    const data = snap.val();
                    if (data) {
                        const arr = Object.keys(data).map(k => ({id: k, ...data[k]})).sort((a,b) => b.timestamp - a.timestamp);
                        setPolls(arr);
                    } else {
                        setPolls([]);
                    }
                });
                
                const saved = localStorage.getItem('myVotes');
                if (saved) {
                    try {
                        setMyVotes(JSON.parse(saved));
                    } catch (e) {}
                }
            }, []);

            // ÎÜçÏû• Ïú†Ï†Ä Î°úÎìú
            useEffect(() => {
                db.ref('farmUsers').on('value', snap => {
                    const data = snap.val();
                    if (data) {
                        const arr = Object.keys(data).map(k => ({id: k, ...data[k]})).sort((a,b) => b.length - a.length);
                        setAllUsers(arr);
                        
                        const token = localStorage.getItem('farmToken');
                        if (token) {
                            const me = arr.find(u => u.id === token);
                            if (me) setFarmUser(me);
                        }
                    }
                });
            }, []);

            // PVP ÏöîÏ≤≠ Î°úÎìú
            useEffect(() => {
                db.ref('pvpRequests').on('value', snap => {
                    const data = snap.val();
                    const token = localStorage.getItem('farmToken');
                    if (data && token) {
                        const arr = Object.keys(data).map(k => ({id: k, ...data[k]}))
                            .filter(r => r.status === 'pending')
                            .sort((a,b) => b.timestamp - a.timestamp);
                        setPvpReqs(arr);
                    } else {
                        setPvpReqs([]);
                    }
                });
            }, []);

            // ÌÉÄÏù¥Î®∏
            useEffect(() => {
                const update = () => {
                    if (!farmUser || !farmUser.lastCheckIn) {
                        setTimer('Ï∂úÏÑù Í∞ÄÎä•!');
                        return;
                    }
                    const now = Date.now();
                    const diff = now - farmUser.lastCheckIn;
                    const cooldown = 24 * 60 * 60 * 1000;
                    if (diff >= cooldown) {
                        setTimer('Ï∂úÏÑù Í∞ÄÎä•!');
                    } else {
                        const left = cooldown - diff;
                        const h = Math.floor(left / 3600000);
                        const m = Math.floor((left % 3600000) / 60000);
                        const s = Math.floor((left % 60000) / 1000);
                        setTimer(`${h}ÏãúÍ∞Ñ ${m}Î∂Ñ ${s}Ï¥à`);
                    }
                };
                update();
                const iv = setInterval(update, 1000);
                return () => clearInterval(iv);
            }, [farmUser]);
            
            // ÎßàÌîºÏïÑ Î∞© Î™©Î°ù Î¶¨Ïä§ÎÑà
            useEffect(() => {
                const roomsRef = db.ref('mafia/rooms');
                roomsRef.on('value', (snapshot) => {
                    const rooms = snapshot.val() || {};
                    // 10Î∂Ñ Ïù¥ÏÉÅ Îêú ÎåÄÍ∏∞Ï§ë Î∞© ÏûêÎèô ÏÇ≠Ï†ú
                    const now = Date.now();
                    Object.entries(rooms).forEach(([roomId, room]) => {
                        if (room.phase === MAFIA_PHASES.WAITING && (now - room.createdAt) > 600000) {
                            db.ref(`mafia/rooms/${roomId}`).remove();
                        }
                    });
                    setMafiaRooms(rooms);
                });
                return () => roomsRef.off();
            }, []);
            
            // ÎßàÌîºÏïÑ Ï±ÑÌåÖ Î¶¨Ïä§ÎÑà
            useEffect(() => {
                if (currentMafiaRoom) {
                    const messagesRef = db.ref(`mafia/rooms/${currentMafiaRoom}/messages`);
                    messagesRef.limitToLast(50).on('value', (snapshot) => {
                        const msgs = [];
                        snapshot.forEach((child) => {
                            msgs.push({ id: child.key, ...child.val() });
                        });
                        setMafiaMessages(msgs);
                        setTimeout(() => {
                            if (mafiaChatRef.current) {
                                mafiaChatRef.current.scrollTop = mafiaChatRef.current.scrollHeight;
                            }
                        }, 100);
                    });
                    return () => messagesRef.off();
                }
            }, [currentMafiaRoom]);
            
            // ÎßàÌîºÏïÑ ÌÉÄÏù¥Î®∏ & ÏûêÎèô ÏßÑÌñâ
            useEffect(() => {
                if (!currentMafiaRoom || !mafiaRooms[currentMafiaRoom]) return;
                const room = mafiaRooms[currentMafiaRoom];
                if (!room.phaseEndTime || room.phase === MAFIA_PHASES.WAITING) return;
                const interval = setInterval(() => {
                    const now = Date.now();
                    const remaining = Math.max(0, Math.floor((room.phaseEndTime - now) / 1000));
                    setMafiaTimeLeft(remaining);
                    if (remaining === 0) { handleMafiaPhaseEnd(); }
                }, 1000);
                return () => clearInterval(interval);
            }, [currentMafiaRoom, mafiaRooms]);

            // Í≤åÏãúÍ∏Ä ÏûëÏÑ±
            const writePost = () => {
                if (!postTitle.trim() || !postContent.trim() || !postAuthor.trim()) {
                    alert('Ï†úÎ™©, ÎÇ¥Ïö©, ÏûëÏÑ±ÏûêÎ•º Î™®Îëê ÏûÖÎ†•ÌïòÏÑ∏Ïöî!');
                    return;
                }
                const postId = Date.now().toString();
                db.ref(`posts/${postId}`).set({
                    title: postTitle.trim(),
                    content: postContent.trim(),
                    author: postAuthor.trim(),
                    timestamp: Date.now(),
                    reactions: {},
                    comments: {}
                });
                setPostTitle('');
                setPostContent('');
                setPostAuthor('');
            };

            // Î∞òÏùë Ï∂îÍ∞Ä
            const addReaction = (postId, emoji) => {
                const path = `posts/${postId}/reactions/${myAnonymousId}`;
                db.ref(path).once('value', snap => {
                    if (snap.val() === emoji) {
                        db.ref(path).remove();
                    } else {
                        db.ref(path).set(emoji);
                    }
                });
            };

            // ÎåìÍ∏Ä ÏûëÏÑ±
            const writeComment = (postId) => {
                const content = commentInputs[postId];
                if (!content || !content.trim()) return;
                const commentId = Date.now().toString();
                db.ref(`posts/${postId}/comments/${commentId}`).set({
                    authorId: myAnonymousId,
                    content: content.trim(),
                    timestamp: Date.now()
                });
                setCommentInputs({...commentInputs, [postId]: ''});
            };

            // ÎåìÍ∏Ä ÏûëÏÑ±ÏûêÏùò ÏùµÎ™Ö Î≤àÌò∏ Í≥ÑÏÇ∞
            const getCommentAuthorNumber = (post, authorId) => {
                if (!post.comments) return 1;
                
                const allCommentAuthors = new Set();
                Object.values(post.comments).forEach(c => allCommentAuthors.add(c.authorId));
                
                const sorted = Array.from(allCommentAuthors).sort();
                const index = sorted.indexOf(authorId);
                return index + 1;
            };

            // Ï±ÑÌåÖ Ï†ÑÏÜ°
            const sendChat = () => {
                if (!chatMsg.trim()) return;
                db.ref('chatMessages').push({
                    nickname: chatNick,
                    message: chatMsg.trim(),
                    timestamp: Date.now()
                });
                setChatMsg('');
            };

            // Í±∞ÏßìÎßê ÌÉêÏßÄ
            const detectLie = () => {
                if (!detectorQuestion.trim()) return;
                setDetectorLoading(true);
                setDetectorResult(null);
                
                setTimeout(() => {
                    const isTrue = Math.random() > 0.5;
                    const trueReasons = [
                        'ÌÜµÍ≥ÑÏ†ÅÏúºÎ°ú Í∞ÄÎä•ÏÑ±Ïù¥ ÎÜíÏäµÎãàÎã§',
                        'ÎÖºÎ¶¨Ï†Å ÏùºÍ¥ÄÏÑ±Ïù¥ ÏûàÏäµÎãàÎã§',
                        'ÏÇ¨Ïã§ Ìå®ÌÑ¥Í≥º ÏùºÏπòÌï©ÎãàÎã§',
                        'Í≤ÄÏ¶ù Í∞ÄÎä•Ìïú Ï†ïÎ≥¥ÏûÖÎãàÎã§',
                        'Ïã†Î¢∞ÎèÑÍ∞Ä ÎÜíÏäµÎãàÎã§',
                        'Í∞ùÍ¥ÄÏ†Å Ï¶ùÍ±∞Í∞Ä ÏûàÏäµÎãàÎã§',
                        'ÌÉÄÎãπÏÑ±Ïù¥ Ïù∏Ï†ïÎê©ÎãàÎã§',
                        'Í≥ºÌïôÏ†Å Í∑ºÍ±∞Í∞Ä ÏûàÏäµÎãàÎã§',
                        'Ïó≠ÏÇ¨Ï†Å ÏÇ¨Ïã§Í≥º Î∂ÄÌï©Ìï©ÎãàÎã§',
                        'ÏùºÎ∞òÏ†ÅÏúºÎ°ú Î∞õÏïÑÎì§Ïó¨ÏßÄÎäî ÏÇ¨Ïã§ÏûÖÎãàÎã§'
                    ];
                    const falseReasons = [
                        'ÎÖºÎ¶¨Ï†Å Î™®ÏàúÏù¥ Î∞úÍ≤¨ÎêòÏóàÏäµÎãàÎã§',
                        'ÌÜµÍ≥ÑÏ†ÅÏúºÎ°ú Í∞ÄÎä•ÏÑ±Ïù¥ ÎÇÆÏäµÎãàÎã§',
                        'ÏÇ¨Ïã§ Ìå®ÌÑ¥Í≥º Î∂àÏùºÏπòÌï©ÎãàÎã§',
                        'Í≤ÄÏ¶ù Î∂àÍ∞ÄÎä•Ìïú Ï†ïÎ≥¥ÏûÖÎãàÎã§',
                        'Ïã†Î¢∞ÎèÑÍ∞Ä ÎÇÆÏäµÎãàÎã§',
                        'Í∞ùÍ¥ÄÏ†Å Ï¶ùÍ±∞Í∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§',
                        'ÌÉÄÎãπÏÑ±Ïù¥ ÏùòÏã¨Îê©ÎãàÎã§',
                        'Í≥ºÌïôÏ†Å Í∑ºÍ±∞Í∞Ä ÏóÜÏäµÎãàÎã§',
                        'Ïó≠ÏÇ¨Ï†Å ÏÇ¨Ïã§Í≥º Îã§Î¶ÖÎãàÎã§',
                        'ÏùºÎ∞òÏ†ÅÏúºÎ°ú ÌóàÏúÑÎ°ú ÏïåÎ†§Ï†∏ ÏûàÏäµÎãàÎã§',
                        'ÏùòÏã¨Ïä§Îü¨Ïö¥ ÏßÑÏà†ÏûÖÎãàÎã§',
                        'ÌôïÏù∏ÎêòÏßÄ ÏïäÏùÄ Ï†ïÎ≥¥ÏûÖÎãàÎã§',
                        'ÎπÑÎÖºÎ¶¨Ï†Å Ï£ºÏû•ÏûÖÎãàÎã§',
                        'ÏÇ¨Ïã§ Í¥ÄÍ≥ÑÍ∞Ä Î∂àÎ∂ÑÎ™ÖÌï©ÎãàÎã§',
                        'Ïã†ÎπôÏÑ±Ïù¥ Îñ®Ïñ¥ÏßëÎãàÎã§'
                    ];
                    
                    const reasons = isTrue ? trueReasons : falseReasons;
                    const reason = reasons[Math.floor(Math.random() * reasons.length)];
                    
                    setDetectorResult({
                        isTrue: isTrue,
                        reason: reason
                    });
                    setDetectorLoading(false);
                }, 2000);
            };

            // Ìà¨Ìëú ÏÉùÏÑ±
            const createPoll = () => {
                if (!pollQuestion.trim()) return;
                const validOptions = pollOptions.filter(o => o.trim());
                if (validOptions.length < 2) {
                    alert('ÏµúÏÜå 2Í∞ú ÏÑ†ÌÉùÏßÄ ÌïÑÏöî!');
                    return;
                }
                
                const pollId = Date.now().toString();
                db.ref(`polls/${pollId}`).set({
                    question: pollQuestion.trim(),
                    options: validOptions.map(o => o.trim()),
                    votes: {},
                    timestamp: Date.now()
                });
                
                setPollQuestion('');
                setPollOptions(['', '']);
            };

            // Ìà¨ÌëúÌïòÍ∏∞
            const vote = (pollId, optionIndex) => {
                const fingerprint = localStorage.getItem('browserFingerprint') || 
                    'fp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('browserFingerprint', fingerprint);
                
                db.ref(`polls/${pollId}/votes/${fingerprint}`).set(optionIndex);
                
                const newVotes = {...myVotes, [pollId]: optionIndex};
                setMyVotes(newVotes);
                localStorage.setItem('myVotes', JSON.stringify(newVotes));
            };

            // ÎÜçÏû• ÌöåÏõêÍ∞ÄÏûÖ
            const register = () => {
                if (!farmNick.trim() || !farmPass.trim()) {
                    alert('ÎãâÎÑ§ÏûÑÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî!');
                    return;
                }
                if (farmPass.length < 4) {
                    alert('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 4Ïûê Ïù¥ÏÉÅ!');
                    return;
                }
                const exists = allUsers.find(u => u.nickname === farmNick.trim());
                if (exists) {
                    alert('Ïù¥ÎØ∏ ÏÇ¨Ïö© Ï§ëÏù∏ ÎãâÎÑ§ÏûÑ!');
                    return;
                }
                
                const uid = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                db.ref(`farmUsers/${uid}`).set({
                    nickname: farmNick.trim(),
                    password: btoa(farmPass),
                    length: 10,
                    lastCheckIn: 0,
                    createdAt: Date.now()
                }).then(() => {
                    localStorage.setItem('farmToken', uid);
                    setFarmUser({
                        id: uid,
                        nickname: farmNick.trim(),
                        length: 10,
                        lastCheckIn: 0
                    });
                    setFarmNick('');
                    setFarmPass('');
                    alert('ÌöåÏõêÍ∞ÄÏûÖ ÏôÑÎ£å! üéâ');
                });
            };

            // ÎÜçÏû• Î°úÍ∑∏Ïù∏
            const login = () => {
                if (!farmNick.trim() || !farmPass.trim()) {
                    alert('ÎãâÎÑ§ÏûÑÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî!');
                    return;
                }
                const user = allUsers.find(u => u.nickname === farmNick.trim());
                if (!user) {
                    alert('Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Í≥ÑÏ†ï!');
                    return;
                }
                if (user.password !== btoa(farmPass)) {
                    alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§!');
                    return;
                }
                localStorage.setItem('farmToken', user.id);
                setFarmUser(user);
                setFarmNick('');
                setFarmPass('');
                alert('Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ! üå∂Ô∏è');
            };

            // Î°úÍ∑∏ÏïÑÏõÉ
            const logout = () => {
                localStorage.removeItem('farmToken');
                setFarmUser(null);
            };
            
            // Í≥†Ï∂î Îì±Í∏â Í≥ÑÏÇ∞ (20Îã®Í≥Ñ)
            const getGrade = (length) => {
                if (length >= 2501) return { name: 'üåü Ïã†Ïùò ÏòÅÏó≠Ïóê ÎèÑÎã¨Ìïú Í≥†Ï∂î', color: '#000', emoji: 'üëÅÔ∏è' };
                if (length >= 2001) return { name: 'üåÄ Ï∞®ÏõêÏùÑ Ï¥àÏõîÌïú Í≥†Ï∂î', color: '#4a148c', emoji: 'üîÆ' };
                if (length >= 1601) return { name: 'üåå Ïö∞Ï£ºÎ•º ÌíàÏùÄ Í≥†Ï∂î', color: '#6a1b9a', emoji: '‚ú®' };
                if (length >= 1301) return { name: 'üëÅÔ∏è Ï†àÎåÄÏûêÏùò Í≥†Ï∂î', color: '#7b1fa2', emoji: '‚ö°' };
                if (length >= 1001) return { name: 'üî± Ïã†ÏÑ±Ìïú Í≥†Ï∂î', color: '#8e24aa', emoji: 'üí´' };
                if (length >= 801) return { name: '‚òÄÔ∏è Ï≤úÏÉÅÏùò Í≥†Ï∂î', color: '#9c27b0', emoji: 'üåü' };
                if (length >= 651) return { name: '‚≠ê Ï¥àÏõîÏùò Í≥†Ï∂î', color: '#ab47bc', emoji: 'üí†' };
                if (length >= 501) return { name: 'üí´ Î∂àÎ©∏Ïùò Í≥†Ï∂î', color: '#ba68c8', emoji: 'üèÜ' };
                if (length >= 401) return { name: 'üëë Ïã†ÌôîÏùò Í≥†Ï∂î', color: '#e91e63', emoji: 'üíé' };
                if (length >= 301) return { name: 'üèÜ Ï†ÑÏÑ§Ïùò Í≥†Ï∂î', color: '#f44336', emoji: 'üî•' };
                if (length >= 251) return { name: 'üíé Ï∞¨ÎûÄÌïú Í≥†Ï∂î', color: '#ff5722', emoji: '‚ú®' };
                if (length >= 201) return { name: 'üí† ÏòÅÎ°±Ìïú Í≥†Ï∂î', color: '#ff6f00', emoji: 'üî∑' };
                if (length >= 161) return { name: '‚ö° ÎãπÎãπÌïú Í≥†Ï∂î', color: '#ff9800', emoji: '‚≠ê' };
                if (length >= 131) return { name: 'üî∑ ÏúÑÏóÑÏûàÎäî Í≥†Ï∂î', color: '#ffc107', emoji: 'üåü' };
                if (length >= 101) return { name: '‚ú® Ïú§Í∏∞ÎÇòÎäî Í≥†Ï∂î', color: '#ffeb3b', emoji: 'üíß' };
                if (length >= 81) return { name: 'üåü ÌÉêÏä§Îü¨Ïö¥ Í≥†Ï∂î', color: '#8bc34a', emoji: 'üçÄ' };
                if (length >= 61) return { name: 'üçÄ Ïî®ÏïåÏù¥ ÍµµÏùÄ Í≥†Ï∂î', color: '#4caf50', emoji: 'üåø' };
                if (length >= 41) return { name: 'üåø ÌÉ±ÌÉ±Ìïú Í≥†Ï∂î', color: '#00bcd4', emoji: 'üíö' };
                if (length >= 21) return { name: 'üåæ ÎßêÎûëÎßêÎûë Í≥†Ï∂î', color: '#03a9f4', emoji: 'üå±' };
                return { name: 'üå± Ï≠àÍ∏ÄÏ≠àÍ∏Ä Í≥†Ï∂î', color: '#999', emoji: 'üò¢' };
            };
            
            // Í∞ïÌôî ÏÑ±Í≥µ ÌôïÎ•† Í≥ÑÏÇ∞ (ÎåÄÌè≠ Ï¶ùÍ∞Ä)
            const getSuccessRate = (length) => {
                if (length >= 2501) return 30;  // Ïã†Ïùò ÏòÅÏó≠
                if (length >= 2001) return 35;  // Ï∞®ÏõêÏùÑ Ï¥àÏõîÌïú
                if (length >= 1601) return 40;  // Ïö∞Ï£ºÎ•º ÌíàÏùÄ
                if (length >= 1301) return 45;  // Ï†àÎåÄÏûê
                if (length >= 1001) return 50;  // Ïã†ÏÑ±Ìïú
                if (length >= 801) return 55;   // Ï≤úÏÉÅÏùò
                if (length >= 651) return 60;   // Ï¥àÏõîÏùò
                if (length >= 501) return 65;   // Î∂àÎ©∏Ïùò
                if (length >= 401) return 70;   // Ïã†ÌôîÏùò
                if (length >= 301) return 73;   // Ï†ÑÏÑ§Ïùò
                if (length >= 251) return 76;   // Ï∞¨ÎûÄÌïú
                if (length >= 201) return 79;   // ÏòÅÎ°±Ìïú
                if (length >= 161) return 82;   // ÎãπÎãπÌïú
                if (length >= 131) return 85;   // ÏúÑÏóÑÏûàÎäî
                if (length >= 101) return 87;   // Ïú§Í∏∞ÎÇòÎäî
                if (length >= 81) return 89;    // ÌÉêÏä§Îü¨Ïö¥
                if (length >= 61) return 91;    // Ïî®ÏïåÏù¥ ÍµµÏùÄ
                if (length >= 41) return 93;    // ÌÉ±ÌÉ±Ìïú
                if (length >= 21) return 95;    // ÎßêÎûëÎßêÎûë
                return 97;                      // Ï≠àÍ∏ÄÏ≠àÍ∏Ä
            };
            
            // Îì±Í∏âÎ≥Ñ Í∞ïÌôî ÎπÑÏö© Í≥ÑÏÇ∞
            const getForgeCost = (length) => {
                if (length >= 2501) return 200;  // Ïã†Ïùò ÏòÅÏó≠
                if (length >= 2001) return 150;  // Ï∞®ÏõêÏùÑ Ï¥àÏõîÌïú
                if (length >= 1601) return 120;  // Ïö∞Ï£ºÎ•º ÌíàÏùÄ
                if (length >= 1301) return 100;  // Ï†àÎåÄÏûê
                if (length >= 1001) return 80;   // Ïã†ÏÑ±Ìïú
                if (length >= 801) return 70;    // Ï≤úÏÉÅÏùò
                if (length >= 651) return 60;    // Ï¥àÏõîÏùò
                if (length >= 501) return 50;    // Î∂àÎ©∏Ïùò
                if (length >= 401) return 40;    // Ïã†ÌôîÏùò
                if (length >= 301) return 35;    // Ï†ÑÏÑ§Ïùò
                if (length >= 251) return 30;    // Ï∞¨ÎûÄÌïú
                if (length >= 201) return 25;    // ÏòÅÎ°±Ìïú
                if (length >= 161) return 22;    // ÎãπÎãπÌïú
                if (length >= 131) return 20;    // ÏúÑÏóÑÏûàÎäî
                if (length >= 101) return 18;    // Ïú§Í∏∞ÎÇòÎäî
                if (length >= 81) return 15;     // ÌÉêÏä§Îü¨Ïö¥
                if (length >= 61) return 13;     // Ïî®ÏïåÏù¥ ÍµµÏùÄ
                if (length >= 41) return 11;     // ÌÉ±ÌÉ±Ìïú
                if (length >= 21) return 10;     // ÎßêÎûëÎßêÎûë
                return 10;                       // Ï≠àÍ∏ÄÏ≠àÍ∏Ä
            };
            
            // Îì±Í∏âÎ≥Ñ ÏÑ±Í≥µ Î≥¥ÎÑàÏä§ Í≥ÑÏÇ∞
            const getForgeBonus = (length) => {
                if (length >= 2501) return { min: 300, max: 600 };  // Ïã†Ïùò ÏòÅÏó≠
                if (length >= 2001) return { min: 240, max: 500 };  // Ï∞®ÏõêÏùÑ Ï¥àÏõîÌïú
                if (length >= 1601) return { min: 200, max: 400 };  // Ïö∞Ï£ºÎ•º ÌíàÏùÄ
                if (length >= 1301) return { min: 180, max: 360 };  // Ï†àÎåÄÏûê
                if (length >= 1001) return { min: 160, max: 300 };  // Ïã†ÏÑ±Ìïú
                if (length >= 801) return { min: 140, max: 260 };   // Ï≤úÏÉÅÏùò
                if (length >= 651) return { min: 120, max: 240 };   // Ï¥àÏõîÏùò
                if (length >= 501) return { min: 100, max: 200 };   // Î∂àÎ©∏Ïùò
                if (length >= 401) return { min: 90, max: 180 };    // Ïã†ÌôîÏùò
                if (length >= 301) return { min: 80, max: 160 };    // Ï†ÑÏÑ§Ïùò
                if (length >= 251) return { min: 70, max: 140 };    // Ï∞¨ÎûÄÌïú
                if (length >= 201) return { min: 60, max: 120 };    // ÏòÅÎ°±Ìïú
                if (length >= 161) return { min: 56, max: 110 };    // ÎãπÎãπÌïú
                if (length >= 131) return { min: 50, max: 100 };    // ÏúÑÏóÑÏûàÎäî
                if (length >= 101) return { min: 46, max: 90 };     // Ïú§Í∏∞ÎÇòÎäî
                if (length >= 81) return { min: 40, max: 80 };      // ÌÉêÏä§Îü¨Ïö¥
                if (length >= 61) return { min: 36, max: 70 };      // Ïî®ÏïåÏù¥ ÍµµÏùÄ
                if (length >= 41) return { min: 30, max: 60 };      // ÌÉ±ÌÉ±Ìïú
                if (length >= 21) return { min: 24, max: 50 };      // ÎßêÎûëÎßêÎûë
                return { min: 20, max: 40 };                        // Ï≠àÍ∏ÄÏ≠àÍ∏Ä
            };
            
            // Îì±Í∏âÎ≥Ñ Ïã§Ìå® ÏÜêÏã§ Í≥ÑÏÇ∞
            const getForgeLoss = (length) => {
                if (length >= 2501) return { small: 80, big: 150 };  // Ïã†Ïùò ÏòÅÏó≠
                if (length >= 2001) return { small: 70, big: 130 };  // Ï∞®ÏõêÏùÑ Ï¥àÏõîÌïú
                if (length >= 1601) return { small: 60, big: 110 };  // Ïö∞Ï£ºÎ•º ÌíàÏùÄ
                if (length >= 1301) return { small: 55, big: 100 };  // Ï†àÎåÄÏûê
                if (length >= 1001) return { small: 50, big: 90 };   // Ïã†ÏÑ±Ìïú
                if (length >= 801) return { small: 45, big: 80 };    // Ï≤úÏÉÅÏùò
                if (length >= 651) return { small: 40, big: 70 };    // Ï¥àÏõîÏùò
                if (length >= 501) return { small: 35, big: 60 };    // Î∂àÎ©∏Ïùò
                if (length >= 401) return { small: 30, big: 55 };    // Ïã†ÌôîÏùò
                if (length >= 301) return { small: 28, big: 50 };    // Ï†ÑÏÑ§Ïùò
                if (length >= 251) return { small: 25, big: 45 };    // Ï∞¨ÎûÄÌïú
                if (length >= 201) return { small: 22, big: 40 };    // ÏòÅÎ°±Ìïú
                if (length >= 161) return { small: 20, big: 38 };    // ÎãπÎãπÌïú
                if (length >= 131) return { small: 18, big: 35 };    // ÏúÑÏóÑÏûàÎäî
                if (length >= 101) return { small: 16, big: 32 };    // Ïú§Í∏∞ÎÇòÎäî
                if (length >= 81) return { small: 15, big: 30 };     // ÌÉêÏä§Îü¨Ïö¥
                if (length >= 61) return { small: 13, big: 28 };     // Ïî®ÏïåÏù¥ ÍµµÏùÄ
                if (length >= 41) return { small: 11, big: 25 };     // ÌÉ±ÌÉ±Ìïú
                if (length >= 21) return { small: 10, big: 22 };     // ÎßêÎûëÎßêÎûë
                return { small: 8, big: 20 };                        // Ï≠àÍ∏ÄÏ≠àÍ∏Ä
            };
            
            // Îì±Í∏âÎ≥Ñ ÌååÍ¥¥ ÌôïÎ•† Í≥ÑÏÇ∞ (Ï¥àÎ∞ò Í±∞Ïùò ÏóÜÎã§Í∞Ä ÌõÑÎ∞ò ÏµúÎåÄ 5%)
            const getDestroyRate = (length) => {
                if (length >= 2501) return 5.0;   // Ïã†Ïùò ÏòÅÏó≠
                if (length >= 2001) return 4.5;   // Ï∞®ÏõêÏùÑ Ï¥àÏõîÌïú
                if (length >= 1601) return 4.0;   // Ïö∞Ï£ºÎ•º ÌíàÏùÄ
                if (length >= 1301) return 3.5;   // Ï†àÎåÄÏûê
                if (length >= 1001) return 3.0;   // Ïã†ÏÑ±Ìïú
                if (length >= 801) return 2.5;    // Ï≤úÏÉÅÏùò
                if (length >= 651) return 2.0;    // Ï¥àÏõîÏùò
                if (length >= 501) return 1.5;    // Î∂àÎ©∏Ïùò
                if (length >= 401) return 1.2;    // Ïã†ÌôîÏùò
                if (length >= 301) return 1.0;    // Ï†ÑÏÑ§Ïùò
                if (length >= 251) return 0.8;    // Ï∞¨ÎûÄÌïú
                if (length >= 201) return 0.6;    // ÏòÅÎ°±Ìïú
                if (length >= 161) return 0.5;    // ÎãπÎãπÌïú
                if (length >= 131) return 0.4;    // ÏúÑÏóÑÏûàÎäî
                if (length >= 101) return 0.3;    // Ïú§Í∏∞ÎÇòÎäî
                if (length >= 81) return 0.2;     // ÌÉêÏä§Îü¨Ïö¥
                if (length >= 61) return 0.15;    // Ïî®ÏïåÏù¥ ÍµµÏùÄ
                if (length >= 41) return 0.1;     // ÌÉ±ÌÉ±Ìïú
                if (length >= 21) return 0.05;    // ÎßêÎûëÎßêÎûë
                return 0.01;                      // Ï≠àÍ∏ÄÏ≠àÍ∏Ä (Í±∞Ïùò ÏóÜÏùå)
            };
            
            // Í∞ïÌôî ÏãúÎèÑ
            const tryForge = () => {
                if (!farmUser) return;
                if (forging) return;
                
                const cost = getForgeCost(farmUser.length);
                
                if (farmUser.length < cost) {
                    alert(`Í∞ïÌôî ÎπÑÏö©Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§! (ÌïÑÏöî: ${cost}cm, ÌòÑÏû¨: ${farmUser.length}cm)`);
                    return;
                }
                
                setForging(true);
                
                const currentGrade = getGrade(farmUser.length);
                const successRate = getSuccessRate(farmUser.length);
                const isSuccess = Math.random() * 100 < successRate;
                
                setTimeout(() => {
                    if (isSuccess) {
                        // Í∞ïÌôî ÏÑ±Í≥µ - Îì±Í∏âÎ≥Ñ Î≥¥ÎÑàÏä§
                        const bonusRange = getForgeBonus(farmUser.length);
                        const bonus = Math.floor(Math.random() * (bonusRange.max - bonusRange.min + 1)) + bonusRange.min;
                        const newLength = farmUser.length - cost + bonus;
                        const newGrade = getGrade(newLength);
                        
                        db.ref(`farmUsers/${farmUser.id}`).update({
                            length: newLength
                        });
                        
                        db.ref('chatMessages').push({
                            nickname: 'üî® ÎåÄÏû•Í∞Ñ ÏãúÏä§ÌÖú',
                            message: `${farmUser.nickname}ÎãòÏù¥ Í∞ïÌôîÏóê ÏÑ±Í≥µ! ${bonus}cm ÌöçÎìù! (ÎπÑÏö©: ${cost}cm) ${currentGrade.emoji}${currentGrade.name} ‚Üí ${newGrade.emoji}${newGrade.name} (ÌòÑÏû¨: ${newLength}cm)`,
                            timestamp: Date.now()
                        });
                        
                        setForgeResult({
                            success: true,
                            oldLength: farmUser.length,
                            newLength: newLength,
                            oldGrade: currentGrade,
                            newGrade: newGrade,
                            change: bonus,
                            cost: cost
                        });
                    } else {
                        // Í∞ïÌôî Ïã§Ìå® - Îì±Í∏âÎ≥Ñ ÏÜêÏã§ Î∞è ÌååÍ¥¥
                        const rand = Math.random() * 100;
                        const lossRange = getForgeLoss(farmUser.length);
                        const destroyRate = getDestroyRate(farmUser.length);
                        let newLength;
                        let message;
                        
                        if (rand < destroyRate) {
                            // Îì±Í∏âÎ≥Ñ ÌååÍ¥¥ ÌôïÎ•† (Ï¥àÎ∞ò 0.01% ‚Üí ÏµúÏ¢Ö 5%)
                            newLength = 0;
                            message = `${farmUser.nickname}ÎãòÏùò Í∞ïÌôî Ïã§Ìå®... Í≥†Ï∂îÍ∞Ä ÏôÑÏ†ÑÌûà ÌååÍ¥¥ÎêòÏóàÏäµÎãàÎã§! üí• (0cm)`;
                        } else if (rand < destroyRate + 30) {
                            // 30% ÌôïÎ•†Î°ú ÌÅ∞ ÏÜêÏã§
                            const loss = lossRange.big;
                            newLength = Math.max(0, farmUser.length - cost - loss);
                            message = `${farmUser.nickname}ÎãòÏùò Í∞ïÌôî Ïã§Ìå®... ${loss}cm ÌÅ∞ ÏÜêÏã§! (ÎπÑÏö©: ${cost}cm) (ÌòÑÏû¨: ${newLength}cm)`;
                        } else {
                            // ÎÇòÎ®∏ÏßÄ ÌôïÎ•†Î°ú ÏûëÏùÄ ÏÜêÏã§
                            const loss = lossRange.small;
                            newLength = Math.max(0, farmUser.length - cost - loss);
                            message = `${farmUser.nickname}ÎãòÏùò Í∞ïÌôî Ïã§Ìå®... ${loss}cm ÏÜêÏã§! (ÎπÑÏö©: ${cost}cm) (ÌòÑÏû¨: ${newLength}cm)`;
                        }
                        
                        const newGrade = getGrade(newLength);
                        
                        db.ref(`farmUsers/${farmUser.id}`).update({
                            length: newLength
                        });
                        
                        db.ref('chatMessages').push({
                            nickname: 'üî® ÎåÄÏû•Í∞Ñ ÏãúÏä§ÌÖú',
                            message: message,
                            timestamp: Date.now()
                        });
                        
                        setForgeResult({
                            success: false,
                            oldLength: farmUser.length,
                            newLength: newLength,
                            oldGrade: currentGrade,
                            newGrade: newGrade,
                            change: newLength - farmUser.length + cost,
                            cost: cost
                        });
                    }
                    
                    setForging(false);
                    setTimeout(() => setForgeResult(null), 5000);
                }, 2000);
            };

            // Ï∂úÏÑùÏ≤¥ÌÅ¨
            const checkIn = () => {
                if (!farmUser) return;
                const now = Date.now();
                if (farmUser.lastCheckIn && (now - farmUser.lastCheckIn) < 24 * 60 * 60 * 1000) {
                    alert('ÏïÑÏßÅ Ï∂úÏÑù Î∂àÍ∞Ä!');
                    return;
                }
                const growth = Math.floor(Math.random() * 100) + 1;
                const newLen = (farmUser.length || 10) + growth;
                db.ref(`farmUsers/${farmUser.id}`).update({
                    length: newLen,
                    lastCheckIn: now
                });
                db.ref('chatMessages').push({
                    nickname: 'üå∂Ô∏è ÎÜçÏû• ÏãúÏä§ÌÖú',
                    message: `${farmUser.nickname}ÎãòÏù¥ Ï∂úÏÑùÏ≤¥ÌÅ¨Î°ú ${growth}cm ÏÑ±Ïû•! (ÌòÑÏû¨: ${newLen}cm)`,
                    timestamp: Date.now()
                });
                alert(`üå∂Ô∏è ${growth}cm ÏÑ±Ïû•! (ÌòÑÏû¨: ${newLen}cm)`);
            };

            // PVP Ïã†Ï≤≠ (Ïò§Ìîà Î∞∞ÌãÄ)
            const sendPvp = () => {
                if (!pvpAmount) return;
                if (!farmUser) return;
                
                const amt = parseInt(pvpAmount);
                if (amt <= 0 || isNaN(amt)) {
                    alert('Ïò¨Î∞îÎ•∏ Ïà´Ïûê!');
                    return;
                }
                
                if (farmUser.length < amt) {
                    alert(`Í∏∏Ïù¥Í∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§! (ÌïÑÏöî: ${amt}cm, ÌòÑÏû¨: ${farmUser.length}cm)`);
                    return;
                }
                
                db.ref('pvpRequests').push({
                    fromId: farmUser.id,
                    fromName: farmUser.nickname,
                    amount: amt,
                    status: 'pending',
                    timestamp: Date.now()
                });
                
                // Ï±ÑÌåÖÏóê Ïò§Ìîà Î∞∞ÌãÄ Î∞úÌëú
                db.ref('chatMessages').push({
                    nickname: '‚öîÔ∏è PVP ÏãúÏä§ÌÖú',
                    message: `${farmUser.nickname}ÎãòÏù¥ ${amt}cm Ïò§Ìîà Î∞∞ÌãÄÏùÑ Ïã†Ï≤≠ÌñàÏäµÎãàÎã§! (ÎàÑÍµ¨ÎÇò ÏàòÎùΩ Í∞ÄÎä•)`,
                    timestamp: Date.now()
                });
                
                setPvpAmount('');
                alert('Ïò§Ìîà Î∞∞ÌãÄ Ïã†Ï≤≠ ÏôÑÎ£å! ÎàÑÍµ∞Í∞Ä ÏàòÎùΩÌï† ÎïåÍπåÏßÄ ÎåÄÍ∏∞Ìï©ÎãàÎã§.');
            };

            // PVP ÏàòÎùΩ (Ïò§Ìîà Î∞∞ÌãÄ)
            const acceptPvp = (req) => {
                if (!farmUser) return;
                
                // ÏûêÍ∏∞ ÏûêÏã†Ïùò Î∞∞ÌãÄÏùÄ ÏàòÎùΩ Î∂àÍ∞Ä
                if (req.fromId === farmUser.id) {
                    alert('ÏûêÏã†Ïùò Î∞∞ÌãÄÏùÄ ÏàòÎùΩÌï† Ïàò ÏóÜÏäµÎãàÎã§!');
                    return;
                }
                
                // ÏµúÏã† Ïú†Ï†Ä Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const challenger = allUsers.find(u => u.id === req.fromId);
                const accepter = farmUser;
                
                if (!challenger) {
                    alert('ÎèÑÏ†ÑÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
                    db.ref(`pvpRequests/${req.id}`).update({ status: 'cancelled' });
                    return;
                }
                
                // ÏñëÏ™Ω Í∏∏Ïù¥ Ï≤¥ÌÅ¨
                if (challenger.length < req.amount) {
                    alert(`ÎèÑÏ†ÑÏûê(${challenger.nickname})Ïùò Í∏∏Ïù¥Í∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§! Î∞∞ÌãÄÏù¥ ÏûêÎèô Ï∑®ÏÜåÎê©ÎãàÎã§.`);
                    db.ref(`pvpRequests/${req.id}`).update({ status: 'cancelled' });
                    db.ref('chatMessages').push({
                        nickname: '‚öîÔ∏è PVP ÏãúÏä§ÌÖú',
                        message: `${challenger.nickname}ÎãòÏùò Î∞∞ÌãÄÏù¥ ÏûêÎèô Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§. (Í∏∏Ïù¥ Î∂ÄÏ°±)`,
                        timestamp: Date.now()
                    });
                    return;
                }
                
                if (accepter.length < req.amount) {
                    alert('ÎãπÏã†Ïùò Í∏∏Ïù¥Í∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§! Î∞∞ÌãÄÏù¥ ÏûêÎèô Ï∑®ÏÜåÎê©ÎãàÎã§.');
                    db.ref(`pvpRequests/${req.id}`).update({ status: 'cancelled' });
                    db.ref('chatMessages').push({
                        nickname: '‚öîÔ∏è PVP ÏãúÏä§ÌÖú',
                        message: `${accepter.nickname}ÎãòÏùò Í∏∏Ïù¥ Î∂ÄÏ°±ÏúºÎ°ú Î∞∞ÌãÄÏù¥ ÏûêÎèô Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.`,
                        timestamp: Date.now()
                    });
                    return;
                }
                
                // Ï±ÑÌåÖÏóê ÏàòÎùΩ Î∞úÌëú
                db.ref('chatMessages').push({
                    nickname: '‚öîÔ∏è PVP ÏãúÏä§ÌÖú',
                    message: `${accepter.nickname}ÎãòÏù¥ ${challenger.nickname}ÎãòÏùò ${req.amount}cm Î∞∞ÌãÄÏùÑ ÏàòÎùΩÌñàÏäµÎãàÎã§! Î∞∞ÌãÄ ÏãúÏûë!`,
                    timestamp: Date.now()
                });
                
                // ÏäπÎ∂Ä (50%)
                const win = Math.random() > 0.5;
                const winnerId = win ? accepter.id : challenger.id;
                const loserId = win ? challenger.id : accepter.id;
                const winner = win ? accepter : challenger;
                const loser = win ? challenger : accepter;
                
                const updates = {};
                updates[`farmUsers/${winnerId}/length`] = winner.length + req.amount;
                updates[`farmUsers/${loserId}/length`] = Math.max(0, loser.length - req.amount);
                updates[`pvpRequests/${req.id}/status`] = 'completed';
                updates[`pvpRequests/${req.id}/accepterId`] = accepter.id;
                updates[`pvpRequests/${req.id}/accepterName`] = accepter.nickname;
                db.ref().update(updates);
                
                // Î∞∞ÌãÄ Í≤∞Í≥º Î∞úÌëú
                db.ref('chatMessages').push({
                    nickname: '‚öîÔ∏è PVP ÏãúÏä§ÌÖú',
                    message: `${winner.nickname}ÎãòÏù¥ ${loser.nickname}ÎãòÏùÑ Ïù¥ÍπÄ! ${req.amount}cm ÌöçÎìù! (ÏäπÏûê: ${winner.length + req.amount}cm, Ìå®Ïûê: ${Math.max(0, loser.length - req.amount)}cm)`,
                    timestamp: Date.now()
                });
                
                setPvpResult({
                    winner: winner.nickname,
                    loser: loser.nickname,
                    amount: req.amount,
                    isWin: winnerId === farmUser.id
                });
                setTimeout(() => setPvpResult(null), 5000);
            };

            // PVP Ï∑®ÏÜå (Ïã†Ï≤≠Ïûê Î≥∏Ïù∏Îßå)
            const cancelPvp = (reqId) => {
                const req = pvpReqs.find(r => r.id === reqId);
                if (req) {
                    if (req.fromId !== farmUser.id) {
                        alert('Î≥∏Ïù∏Ïù¥ Ïã†Ï≤≠Ìïú Î∞∞ÌãÄÎßå Ï∑®ÏÜåÌï† Ïàò ÏûàÏäµÎãàÎã§!');
                        return;
                    }
                    
                    db.ref(`pvpRequests/${reqId}`).update({ status: 'cancelled' });
                    
                    // Ï±ÑÌåÖÏóê Ï∑®ÏÜå Î∞úÌëú
                    db.ref('chatMessages').push({
                        nickname: '‚öîÔ∏è PVP ÏãúÏä§ÌÖú',
                        message: `${req.fromName}ÎãòÏù¥ ${req.amount}cm Î∞∞ÌãÄÏùÑ Ï∑®ÏÜåÌñàÏäµÎãàÎã§.`,
                        timestamp: Date.now()
                    });
                }
            };
            
            
            // Ïù∏ÏõêÎ≥Ñ Ïó≠Ìï† Î∞∞Ï†ï
            const getRoleDistribution = (playerCount) => {
                if (playerCount < 4) return null;
                const roles = [];
                if (playerCount >= 4 && playerCount <= 5) {
                    roles.push('MAFIA'); roles.push('POLICE');
                    while (roles.length < playerCount) roles.push('CITIZEN');
                } else if (playerCount >= 6 && playerCount <= 7) {
                    roles.push('MAFIA', 'MAFIA'); roles.push('POLICE'); roles.push('DOCTOR');
                    while (roles.length < playerCount) roles.push('CITIZEN');
                } else if (playerCount >= 8 && playerCount <= 9) {
                    roles.push('MAFIA', 'MAFIA'); roles.push('POLICE'); roles.push('DOCTOR');
                    while (roles.length < playerCount) roles.push('CITIZEN');
                } else if (playerCount >= 10 && playerCount <= 11) {
                    roles.push('MAFIA', 'MAFIA', 'MAFIA'); roles.push('POLICE'); roles.push('DOCTOR');
                    while (roles.length < playerCount) roles.push('CITIZEN');
                } else {
                    roles.push('MAFIA', 'MAFIA', 'MAFIA'); roles.push('POLICE', 'POLICE'); roles.push('DOCTOR');
                    while (roles.length < playerCount) roles.push('CITIZEN');
                }
                return roles;
            };
            const shuffle = (array) => {
                const arr = [...array];
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            };
            
            // ÎßàÌîºÏïÑ Î∞© ÏÉùÏÑ±
            const createMafiaRoom = async () => {
                if (!newMafiaRoomName.trim() || !myMafiaNick.trim()) {
                    alert('Î∞© Ïù¥Î¶ÑÍ≥º ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!'); return;
                }
                const roomId = 'room_' + Date.now();
                const playerId = 'player_' + Date.now();
                await db.ref(`mafia/rooms/${roomId}`).set({
                    name: newMafiaRoomName, maxPlayers: parseInt(newMafiaRoomMax),
                    host: playerId, phase: MAFIA_PHASES.WAITING,
                    players: { [playerId]: { nickname: myMafiaNick, ready: true, alive: true, joinedAt: Date.now() } },
                    createdAt: Date.now()
                });
                setMyMafiaId(playerId); setCurrentMafiaRoom(roomId); setMafiaScreen('room');
                addMafiaSystemMessage(roomId, `${myMafiaNick}ÎãòÏù¥ Î∞©ÏùÑ ÏÉùÏÑ±ÌñàÏäµÎãàÎã§.`);
            };
            
            // ÎßàÌîºÏïÑ Î∞© Ï∞∏Í∞Ä
            const joinMafiaRoom = async (roomId) => {
                if (!myMafiaNick.trim()) { alert('ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!'); return; }
                const room = mafiaRooms[roomId];
                const playerCount = Object.keys(room.players || {}).length;
                if (playerCount >= room.maxPlayers) { alert('Î∞©Ïù¥ Í∞ÄÎìù Ï∞ºÏäµÎãàÎã§!'); return; }
                if (room.phase !== MAFIA_PHASES.WAITING) { alert('Ïù¥ÎØ∏ Í≤åÏûÑÏù¥ ÏßÑÌñâÏ§ëÏûÖÎãàÎã§!'); return; }
                const playerId = 'player_' + Date.now();
                await db.ref(`mafia/rooms/${roomId}/players/${playerId}`).set({
                    nickname: myMafiaNick, ready: false, alive: true, joinedAt: Date.now()
                });
                setMyMafiaId(playerId); setCurrentMafiaRoom(roomId); setMafiaScreen('room');
                addMafiaSystemMessage(roomId, `${myMafiaNick}ÎãòÏù¥ ÏûÖÏû•ÌñàÏäµÎãàÎã§.`);
            };
            
            // ÎßàÌîºÏïÑ Î∞© ÎÇòÍ∞ÄÍ∏∞
            const leaveMafiaRoom = async () => {
                if (!currentMafiaRoom) return;
                const room = mafiaRooms[currentMafiaRoom];
                await db.ref(`mafia/rooms/${currentMafiaRoom}/players/${myMafiaId}`).remove();
                if (room.host === myMafiaId) {
                    const remainingPlayers = Object.keys(room.players || {}).filter(id => id !== myMafiaId);
                    if (remainingPlayers.length > 0) {
                        await db.ref(`mafia/rooms/${currentMafiaRoom}/host`).set(remainingPlayers[0]);
                    } else {
                        await db.ref(`mafia/rooms/${currentMafiaRoom}`).remove();
                    }
                }
                addMafiaSystemMessage(currentMafiaRoom, `${myMafiaNick}ÎãòÏù¥ Ìá¥Ïû•ÌñàÏäµÎãàÎã§.`);
                setCurrentMafiaRoom(null); setMyMafiaId(''); setMafiaScreen('lobby');
            };
            
            // ÌîåÎ†àÏù¥Ïñ¥ Ï∂îÎ∞© (Î∞©Ïû• Ï†ÑÏö©)
            const kickMafiaPlayer = async (playerId) => {
                const room = mafiaRooms[currentMafiaRoom];
                if (room.host !== myMafiaId) {
                    alert('Î∞©Ïû•Îßå Ï∂îÎ∞©Ìï† Ïàò ÏûàÏäµÎãàÎã§!'); return;
                }
                if (playerId === myMafiaId) {
                    alert('ÏûêÍ∏∞ ÏûêÏã†ÏùÄ Ï∂îÎ∞©Ìï† Ïàò ÏóÜÏäµÎãàÎã§!'); return;
                }
                const kickedPlayer = room.players[playerId];
                await db.ref(`mafia/rooms/${currentMafiaRoom}/players/${playerId}`).remove();
                addMafiaSystemMessage(currentMafiaRoom, `${kickedPlayer.nickname}ÎãòÏù¥ Ï∂îÎ∞©ÎêòÏóàÏäµÎãàÎã§.`);
            };
            
            // Ï§ÄÎπÑ
            const toggleMafiaReady = async () => {
                const room = mafiaRooms[currentMafiaRoom];
                const isReady = room.players[myMafiaId].ready;
                await db.ref(`mafia/rooms/${currentMafiaRoom}/players/${myMafiaId}/ready`).set(!isReady);
            };
            
            // Í≤åÏûÑ ÏãúÏûë
            const startMafiaGame = async () => {
                const room = mafiaRooms[currentMafiaRoom];
                const players = Object.entries(room.players);
                if (players.length < 4) {
                    alert('ÏµúÏÜå 4Î™Ö Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Í≤åÏûÑÏùÑ ÏãúÏûëÌï† Ïàò ÏûàÏäµÎãàÎã§!'); return;
                }
                const allReady = players.every(([id, p]) => p.ready || id === room.host);
                if (!allReady) { alert('Î™®Îì† ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Ï§ÄÎπÑÌï¥Ïïº Ìï©ÎãàÎã§!'); return; }
                const roles = getRoleDistribution(players.length);
                const shuffledRoles = shuffle(roles);
                const updates = {};
                players.forEach(([id], index) => {
                    updates[`mafia/rooms/${currentMafiaRoom}/players/${id}/role`] = shuffledRoles[index];
                    updates[`mafia/rooms/${currentMafiaRoom}/players/${id}/alive`] = true;
                });
                updates[`mafia/rooms/${currentMafiaRoom}/phase`] = MAFIA_PHASES.DAY;
                updates[`mafia/rooms/${currentMafiaRoom}/day`] = 1;
                updates[`mafia/rooms/${currentMafiaRoom}/phaseEndTime`] = Date.now() + 90000;
                updates[`mafia/rooms/${currentMafiaRoom}/winner`] = null;
                await db.ref().update(updates);
                const roleCount = {};
                shuffledRoles.forEach(r => { roleCount[r] = (roleCount[r] || 0) + 1; });
                const roleMsg = Object.entries(roleCount)
                    .map(([role, count]) => `${MAFIA_ROLES[role].emoji}${MAFIA_ROLES[role].name} ${count}Î™Ö`).join(', ');
                addMafiaSystemMessage(currentMafiaRoom, `üéÆ Í≤åÏûÑÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§! (${roleMsg})`);
                addMafiaSystemMessage(currentMafiaRoom, '‚òÄÔ∏è 1ÏùºÏ∞® ÎÇÆÏù¥ ÎêòÏóàÏäµÎãàÎã§. ÏûêÏú†Î°≠Í≤å ÎåÄÌôîÌïòÏÑ∏Ïöî! (90Ï¥à)');
            };
            
            // ÌéòÏù¥Ï¶à Ï¢ÖÎ£å Ï≤òÎ¶¨ (ÏûêÎèô)
            const handleMafiaPhaseEnd = async () => {
                const room = mafiaRooms[currentMafiaRoom];
                if (!room || room.host !== myMafiaId) return;
                if (room.phase === MAFIA_PHASES.DAY) {
                    await db.ref(`mafia/rooms/${currentMafiaRoom}`).update({
                        phase: MAFIA_PHASES.VOTE, phaseEndTime: Date.now() + 40000, votes: {}
                    });
                    addMafiaSystemMessage(currentMafiaRoom, 'üó≥Ô∏è Ìà¨Ìëú ÏãúÍ∞ÑÏûÖÎãàÎã§! ÏùòÏã¨Ïä§Îü¨Ïö¥ ÏÇ¨ÎûåÏóêÍ≤å Ìà¨ÌëúÌïòÏÑ∏Ïöî! (40Ï¥à)');
                } else if (room.phase === MAFIA_PHASES.VOTE) {
                    await processMafiaVotes();
                } else if (room.phase === MAFIA_PHASES.NIGHT) {
                    await processMafiaNight();
                }
            };
            
            // Ìà¨Ìëú Ï≤òÎ¶¨
            const processMafiaVotes = async () => {
                const room = mafiaRooms[currentMafiaRoom];
                const votes = room.votes || {};
                const voteCount = {};
                Object.values(votes).forEach(targetId => {
                    voteCount[targetId] = (voteCount[targetId] || 0) + 1;
                });
                let maxVotes = 0; let executed = null;
                Object.entries(voteCount).forEach(([playerId, count]) => {
                    if (count > maxVotes) { maxVotes = count; executed = playerId; }
                });
                if (executed && maxVotes > 0) {
                    await db.ref(`mafia/rooms/${currentMafiaRoom}/players/${executed}/alive`).set(false);
                    const executedPlayer = room.players[executed];
                    addMafiaSystemMessage(currentMafiaRoom, 
                        `üíÄ Ìà¨Ìëú Í≤∞Í≥º ${executedPlayer.nickname}ÎãòÏù¥ Ï≤òÌòïÎêòÏóàÏäµÎãàÎã§. ` +
                        `Ïó≠Ìï†: ${MAFIA_ROLES[executedPlayer.role].emoji} ${MAFIA_ROLES[executedPlayer.role].name}`
                    );
                } else {
                    addMafiaSystemMessage(currentMafiaRoom, '‚öñÔ∏è Ìà¨ÌëúÍ∞Ä Î¨¥ÏÇ∞ÎêòÏóàÏäµÎãàÎã§. ÏïÑÎ¨¥ÎèÑ Ï≤òÌòïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }
                const gameEnded = await checkMafiaGameEnd();
                if (!gameEnded) {
                    await db.ref(`mafia/rooms/${currentMafiaRoom}`).update({
                        phase: MAFIA_PHASES.NIGHT, phaseEndTime: Date.now() + 50000, nightActions: {}
                    });
                    addMafiaSystemMessage(currentMafiaRoom, 'üåô Î∞§Ïù¥ ÎêòÏóàÏäµÎãàÎã§. ÎßàÌîºÏïÑÏôÄ ÌäπÏàò ÏßÅÏóÖÏùÄ Îä•Î†•ÏùÑ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî! (50Ï¥à)');
                }
            };
            
            // Î∞§ Ï≤òÎ¶¨
            const processMafiaNight = async () => {
                const room = mafiaRooms[currentMafiaRoom];
                const actions = room.nightActions || {};
                let killed = actions.mafia;
                const saved = actions.doctor;
                const investigated = actions.police;
                if (killed && killed === saved) {
                    addMafiaSystemMessage(currentMafiaRoom, '‚öïÔ∏è ÏùòÏÇ¨Í∞Ä ÎàÑÍµ∞Í∞ÄÎ•º ÏÇ¥Î†∏ÏäµÎãàÎã§!');
                    killed = null;
                }
                if (killed) {
                    await db.ref(`mafia/rooms/${currentMafiaRoom}/players/${killed}/alive`).set(false);
                    const killedPlayer = room.players[killed];
                    addMafiaSystemMessage(currentMafiaRoom, `üíÄ ${killedPlayer.nickname}ÎãòÏù¥ ÎßàÌîºÏïÑÏóêÍ≤å ÏÇ¥Ìï¥ÎãπÌñàÏäµÎãàÎã§.`);
                }
                if (investigated) {
                    const target = room.players[investigated];
                    const policeIds = Object.entries(room.players)
                        .filter(([id, p]) => p.role === 'POLICE' && p.alive).map(([id]) => id);
                    policeIds.forEach(policeId => {
                        const isMafia = target.role === 'MAFIA';
                        addMafiaPrivateMessage(currentMafiaRoom, policeId, 
                            `üîç Ï°∞ÏÇ¨ Í≤∞Í≥º: ${target.nickname}ÎãòÏùÄ ${isMafia ? 'üî™ ÎßàÌîºÏïÑÏûÖÎãàÎã§!' : '‚úÖ ÎßàÌîºÏïÑÍ∞Ä ÏïÑÎãôÎãàÎã§.'}`
                        );
                    });
                }
                const gameEnded = await checkMafiaGameEnd();
                if (!gameEnded) {
                    const newDay = (room.day || 1) + 1;
                    await db.ref(`mafia/rooms/${currentMafiaRoom}`).update({
                        phase: MAFIA_PHASES.DAY, day: newDay, phaseEndTime: Date.now() + 90000
                    });
                    addMafiaSystemMessage(currentMafiaRoom, `‚òÄÔ∏è ${newDay}ÏùºÏ∞® ÎÇÆÏù¥ ÎêòÏóàÏäµÎãàÎã§. ÏûêÏú†Î°≠Í≤å ÎåÄÌôîÌïòÏÑ∏Ïöî! (90Ï¥à)`);
                }
            };
            
            // Í≤åÏûÑ Ï¢ÖÎ£å ÌôïÏù∏
            const checkMafiaGameEnd = async () => {
                const room = mafiaRooms[currentMafiaRoom];
                if (!room) return false;
                const alivePlayers = Object.entries(room.players).filter(([_, p]) => p.alive);
                const aliveMafia = alivePlayers.filter(([_, p]) => p.role === 'MAFIA');
                const aliveCitizens = alivePlayers.filter(([_, p]) => p.role !== 'MAFIA');
                if (aliveMafia.length === 0) {
                    await db.ref(`mafia/rooms/${currentMafiaRoom}`).update({
                        phase: MAFIA_PHASES.WAITING, winner: 'CITIZEN', phaseEndTime: null
                    });
                    addMafiaSystemMessage(currentMafiaRoom, 'üéâ Í≤åÏûÑ Ï¢ÖÎ£å! ÏãúÎØºÌåÄ ÏäπÎ¶¨! Î™®Îì† ÎßàÌîºÏïÑÍ∞Ä Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§!');
                    return true;
                }
                if (aliveMafia.length >= aliveCitizens.length) {
                    await db.ref(`mafia/rooms/${currentMafiaRoom}`).update({
                        phase: MAFIA_PHASES.WAITING, winner: 'MAFIA', phaseEndTime: null
                    });
                    addMafiaSystemMessage(currentMafiaRoom, 'üî™ Í≤åÏûÑ Ï¢ÖÎ£å! ÎßàÌîºÏïÑÌåÄ ÏäπÎ¶¨! ÎßàÌîºÏïÑÍ∞Ä ÏãúÎØºÏùÑ Ïû•ÏïÖÌñàÏäµÎãàÎã§!');
                    return true;
                }
                return false;
            };
            
            // Ìà¨ÌëúÌïòÍ∏∞
            const voteMafiaPlayer = async (targetId) => {
                await db.ref(`mafia/rooms/${currentMafiaRoom}/votes/${myMafiaId}`).set(targetId);
                setMafiaSelectedPlayer('');
                addMafiaSystemMessage(currentMafiaRoom, `${myMafiaNick}ÎãòÏù¥ Ìà¨ÌëúÌñàÏäµÎãàÎã§.`);
            };
            
            // Î∞§ Îä•Î†• ÏÇ¨Ïö©
            const useMafiaNightAbility = async (targetId) => {
                const room = mafiaRooms[currentMafiaRoom];
                const myRole = room.players[myMafiaId].role;
                if (myRole === 'MAFIA') {
                    await db.ref(`mafia/rooms/${currentMafiaRoom}/nightActions/mafia`).set(targetId);
                    addMafiaSystemMessage(currentMafiaRoom, 'ÎßàÌîºÏïÑÍ∞Ä ÎåÄÏÉÅÏùÑ ÏÑ†ÌÉùÌñàÏäµÎãàÎã§...');
                } else if (myRole === 'DOCTOR') {
                    await db.ref(`mafia/rooms/${currentMafiaRoom}/nightActions/doctor`).set(targetId);
                    addMafiaSystemMessage(currentMafiaRoom, 'ÏùòÏÇ¨Í∞Ä ÎàÑÍµ∞Í∞ÄÎ•º Î≥¥Ìò∏ÌïòÍ≥† ÏûàÏäµÎãàÎã§...');
                } else if (myRole === 'POLICE') {
                    await db.ref(`mafia/rooms/${currentMafiaRoom}/nightActions/police`).set(targetId);
                    addMafiaSystemMessage(currentMafiaRoom, 'Í≤ΩÏ∞∞Ïù¥ Ï°∞ÏÇ¨Î•º ÏßÑÌñâÌïòÍ≥† ÏûàÏäµÎãàÎã§...');
                }
                setMafiaSelectedPlayer('');
            };
            
            // ÎßàÌîºÏïÑ Ï±ÑÌåÖ
            const sendMafiaMessage = async () => {
                if (!mafiaChatInput.trim()) return;
                const room = mafiaRooms[currentMafiaRoom];
                const me = room.players[myMafiaId];
                if (room.phase === MAFIA_PHASES.NIGHT && me.role !== 'MAFIA') {
                    alert('Î∞§ÏóêÎäî Ï±ÑÌåÖÌï† Ïàò ÏóÜÏäµÎãàÎã§!'); return;
                }
                await db.ref(`mafia/rooms/${currentMafiaRoom}/messages`).push({
                    player: myMafiaNick, playerId: myMafiaId, text: mafiaChatInput,
                    isMafia: me.role === 'MAFIA' && room.phase === MAFIA_PHASES.NIGHT,
                    timestamp: Date.now()
                });
                setMafiaChatInput('');
            };
            const addMafiaSystemMessage = async (roomId, text) => {
                await db.ref(`mafia/rooms/${roomId}/messages`).push({
                    system: true, text: text, timestamp: Date.now()
                });
            };
            const addMafiaPrivateMessage = async (roomId, playerId, text) => {
                await db.ref(`mafia/rooms/${roomId}/messages`).push({
                    private: true, targetId: playerId, text: text, timestamp: Date.now()
                });
            };

            return (
                <div className="container">
                    <div className="header">
                        <h1>üå∂Ô∏è Ïª§ÎÆ§ÎãàÌã∞ ÏÇ¨Ïù¥Ìä∏</h1>
                    </div>
                    
                    <div className="tabs">
                        <button className={`tab ${tab==='mafia'?'active':''}`} onClick={()=>setTab('mafia')}>üé≠ ÎßàÌîºÏïÑ</button>
                        <button className={`tab ${tab==='board'?'active':''}`} onClick={()=>setTab('board')}>üìù Í≤åÏãúÌåê</button>
                        <button className={`tab ${tab==='chat'?'active':''}`} onClick={()=>setTab('chat')}>üí¨ Ï±ÑÌåÖ</button>
                        <button className={`tab ${tab==='detector'?'active':''}`} onClick={()=>setTab('detector')}>üîç Í±∞ÏßìÎßêÌÉêÏßÄÍ∏∞</button>
                        <button className={`tab ${tab==='poll'?'active':''}`} onClick={()=>setTab('poll')}>üó≥Ô∏è Ìà¨Ìëú</button>
                        <button className={`tab ${tab==='farm'?'active':''}`} onClick={()=>setTab('farm')}>üå∂Ô∏è Í≥†Ï∂îÎÜçÏû•</button>
                        <button className={`tab ${tab==='forge'?'active':''}`} onClick={()=>setTab('forge')}>üî® Í≥†Ï∂îÎåÄÏû•Í∞Ñ</button>
                    </div>
                    
                    {/* Í≤åÏãúÌåê */}
                    
                    {/* ÎßàÌîºÏïÑ Í≤åÏûÑ */}
                    {tab === 'mafia' && (
                        <div>
                            {mafiaScreen === 'lobby' ? (
                                <>
                                    <div className="card">
                                        <h2 style={{marginBottom: '20px'}}>üéÆ ÏÉà Î∞© ÎßåÎì§Í∏∞</h2>
                                        <input type="text" value={myMafiaNick} onChange={(e) => setMyMafiaNick(e.target.value)} placeholder="ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxLength={10} />
                                        <input type="text" value={newMafiaRoomName} onChange={(e) => setNewMafiaRoomName(e.target.value)} placeholder="Î∞© Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxLength={20} />
                                        <select value={newMafiaRoomMax} onChange={(e) => setNewMafiaRoomMax(e.target.value)}>
                                            <option value={4}>4Î™Ö</option>
                                            <option value={6}>6Î™Ö</option>
                                            <option value={8}>8Î™Ö</option>
                                            <option value={10}>10Î™Ö</option>
                                            <option value={12}>12Î™Ö</option>
                                        </select>
                                        <button className="btn" onClick={createMafiaRoom}>Î∞© ÎßåÎì§Í∏∞</button>
                                    </div>
                                    <div className="card">
                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                                            <h2>üìã Î∞© Î™©Î°ù ({Object.keys(mafiaRooms).length}Í∞ú)</h2>
                                            <button className="btn btn-small" onClick={() => setShowMafiaRules(!showMafiaRules)} style={{background: '#9b59b6'}}>
                                                {showMafiaRules ? 'Í∑úÏπô Ïà®Í∏∞Í∏∞' : 'üìñ Í≤åÏûÑ Í∑úÏπô'}
                                            </button>
                                        </div>
                                        {showMafiaRules && (
                                            <div className="mafia-rules">
                                                <h3>üé≠ Í≤åÏûÑ Í∑úÏπô Î∞è Ïó≠Ìï† ÏïàÎÇ¥</h3>
                                                <div className="info-box">
                                                    <h4 style={{marginBottom: '10px'}}>üë• Ïù∏ÏõêÎ≥Ñ Ïó≠Ìï† Î∞∞Ï†ï</h4>
                                                    <ul>
                                                        <li><strong>4-5Î™Ö:</strong> ÎßàÌîºÏïÑ 1Î™Ö, Í≤ΩÏ∞∞ 1Î™Ö, ÏãúÎØº</li>
                                                        <li><strong>6-7Î™Ö:</strong> ÎßàÌîºÏïÑ 2Î™Ö, Í≤ΩÏ∞∞ 1Î™Ö, ÏùòÏÇ¨ 1Î™Ö, ÏãúÎØº</li>
                                                        <li><strong>8-9Î™Ö:</strong> ÎßàÌîºÏïÑ 2Î™Ö, Í≤ΩÏ∞∞ 1Î™Ö, ÏùòÏÇ¨ 1Î™Ö, ÏãúÎØº</li>
                                                        <li><strong>10-11Î™Ö:</strong> ÎßàÌîºÏïÑ 3Î™Ö, Í≤ΩÏ∞∞ 1Î™Ö, ÏùòÏÇ¨ 1Î™Ö, ÏãúÎØº</li>
                                                        <li><strong>12Î™Ö+:</strong> ÎßàÌîºÏïÑ 3Î™Ö, Í≤ΩÏ∞∞ 2Î™Ö, ÏùòÏÇ¨ 1Î™Ö, ÏãúÎØº</li>
                                                    </ul>
                                                </div>
                                                <div className="info-box">
                                                    <h4 style={{marginBottom: '10px'}}>üé≠ Ïó≠Ìï†Î≥Ñ Îä•Î†•</h4>
                                                    <p><strong>üî™ ÎßàÌîºÏïÑ:</strong> Î∞§Ïóê ÏãúÎØº Ìïú Î™ÖÏùÑ Ï†úÍ±∞Ìï©ÎãàÎã§. ÎèôÎ£å ÎßàÌîºÏïÑÎ•º Ïïå Ïàò ÏûàÏäµÎãàÎã§.</p>
                                                    <p><strong>üë§ ÏãúÎØº:</strong> ÌäπÏàò Îä•Î†•ÏùÄ ÏóÜÏßÄÎßå ÌÜ†Î°†Í≥º Ìà¨ÌëúÎ°ú ÎßàÌîºÏïÑÎ•º Ï∞æÏïÑÎÉÖÎãàÎã§.</p>
                                                    <p><strong>‚öïÔ∏è ÏùòÏÇ¨:</strong> Î∞§Ïóê Ìïú Î™ÖÏùÑ ÏÑ†ÌÉùÌïòÏó¨ ÎßàÌîºÏïÑÏùò Í≥µÍ≤©ÏúºÎ°úÎ∂ÄÌÑ∞ Î≥¥Ìò∏Ìï©ÎãàÎã§.</p>
                                                    <p><strong>üëÆ Í≤ΩÏ∞∞:</strong> Î∞§Ïóê Ìïú Î™ÖÏùÑ Ï°∞ÏÇ¨ÌïòÏó¨ ÎßàÌîºÏïÑ Ïó¨Î∂ÄÎ•º ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                                                </div>
                                                <div className="warning-box">
                                                    <h4 style={{marginBottom: '10px'}}>‚è∞ Í≤åÏûÑ ÏßÑÌñâ (ÏûêÎèô)</h4>
                                                    <p><strong>‚òÄÔ∏è ÎÇÆ (90Ï¥à):</strong> ÏûêÏú†Î°≠Í≤å ÌÜ†Î°†ÌïòÍ≥† ÏùòÏã¨Í∞ÄÎäî ÏÇ¨ÎûåÏùÑ Ï∞æÏäµÎãàÎã§.</p>
                                                    <p><strong>üó≥Ô∏è Ìà¨Ìëú (40Ï¥à):</strong> ÏùòÏã¨Ïä§Îü¨Ïö¥ ÏÇ¨ÎûåÏóêÍ≤å Ìà¨ÌëúÌï©ÎãàÎã§. ÏµúÎã§ ÎìùÌëúÏûêÍ∞Ä Ï≤òÌòïÎê©ÎãàÎã§.</p>
                                                    <p><strong>üåô Î∞§ (50Ï¥à):</strong> ÎßàÌîºÏïÑÎäî Ï†úÍ±∞Ìï† ÏÇ¨ÎûåÏùÑ, ÏùòÏÇ¨Îäî Î≥¥Ìò∏Ìï† ÏÇ¨ÎûåÏùÑ, Í≤ΩÏ∞∞ÏùÄ Ï°∞ÏÇ¨Ìï† ÏÇ¨ÎûåÏùÑ ÏÑ†ÌÉùÌï©ÎãàÎã§.</p>
                                                    <p style={{marginTop: '10px', fontWeight: 'bold', color: '#e74c3c'}}>* ÏãúÍ∞ÑÏù¥ ÎÅùÎÇòÎ©¥ ÏûêÎèôÏúºÎ°ú Îã§Ïùå ÌéòÏù¥Ï¶àÎ°ú ÎÑòÏñ¥Í∞ëÎãàÎã§!</p>
                                                </div>
                                                <div className="danger-box">
                                                    <h4 style={{marginBottom: '10px'}}>üèÜ ÏäπÎ¶¨ Ï°∞Í±¥</h4>
                                                    <p><strong>ÏãúÎØºÌåÄ ÏäπÎ¶¨:</strong> Î™®Îì† ÎßàÌîºÏïÑÎ•º Ï†úÍ±∞ÌïòÎ©¥ ÏäπÎ¶¨!</p>
                                                    <p><strong>ÎßàÌîºÏïÑÌåÄ ÏäπÎ¶¨:</strong> ÎßàÌîºÏïÑ Ïàò ‚â• ÏãúÎØº ÏàòÍ∞Ä ÎêòÎ©¥ ÏäπÎ¶¨!</p>
                                                </div>
                                                <div className="info-box">
                                                    <h4 style={{marginBottom: '10px'}}>üí° Í≤åÏûÑ ÌåÅ</h4>
                                                    <p>‚Ä¢ ÎÇÆÏóêÎäî Ï†ÅÍ∑πÏ†ÅÏúºÎ°ú ÏùòÍ≤¨ÏùÑ ÎÇòÎàÑÍ≥† ÏùòÏã¨Ïä§Îü¨Ïö¥ ÌñâÎèôÏùÑ Í¥ÄÏ∞∞ÌïòÏÑ∏Ïöî.</p>
                                                    <p>‚Ä¢ ÎßàÌîºÏïÑÎäî ÎèôÎ£åÎ•º Î≥¥Ìò∏ÌïòÎ©¥ÏÑú ÏãúÎØºÏù∏ Ï≤ô Ïó∞Í∏∞Ìï¥Ïïº Ìï©ÎãàÎã§.</p>
                                                    <p>‚Ä¢ Í≤ΩÏ∞∞Í≥º ÏùòÏÇ¨Îäî ÏûêÏã†Ïùò Ï†ïÏ≤¥Î•º ÎÑàÎ¨¥ ÏùºÏ∞ç Î∞ùÌûàÏßÄ ÎßàÏÑ∏Ïöî.</p>
                                                    <p>‚Ä¢ Ìà¨ÌëúÎäî Ïã†Ï§ëÌïòÍ≤å! ÏûòÎ™ªÎêú Ìà¨ÌëúÎäî ÏãúÎØºÌåÄÏóêÍ≤å Î∂àÎ¶¨Ìï©ÎãàÎã§.</p>
                                                </div>
                                            </div>
                                        )}
                                        {Object.keys(mafiaRooms).length === 0 ? (
                                            <p style={{textAlign: 'center', opacity: 0.7, padding: '40px'}}>ÏïÑÏßÅ ÏÉùÏÑ±Îêú Î∞©Ïù¥ ÏóÜÏäµÎãàÎã§. Ï≤´ Î≤àÏß∏ Î∞©ÏùÑ ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!</p>
                                        ) : (
                                            <div className="mafia-room-list">
                                                {Object.entries(mafiaRooms).map(([roomId, room]) => (
                                                    <div key={roomId} className="mafia-room-card" onClick={() => joinMafiaRoom(roomId)}>
                                                        <div className="mafia-room-header">{room.name}</div>
                                                        <div style={{fontSize: '0.9rem', opacity: 0.9}}>Î∞©Ïû•: {room.players[room.host]?.nickname}</div>
                                                        <div className="mafia-room-info">
                                                            <span>üë• {Object.keys(room.players || {}).length}/{room.maxPlayers}Î™Ö</span>
                                                            <span>{room.phase === MAFIA_PHASES.WAITING ? '‚è∏Ô∏è ÎåÄÍ∏∞Ï§ë' : 'üéÆ Í≤åÏûÑÏ§ë'}</span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </>
                            ) : (
                                (() => {
                                    const room = mafiaRooms[currentMafiaRoom];
                                    if (!room) return null;
                                    const isHost = room.host === myMafiaId;
                                    const me = room.players[myMafiaId];
                                    const alivePlayers = Object.entries(room.players).filter(([_, p]) => p.alive);
                                    const myRole = me?.role ? MAFIA_ROLES[me.role] : null;
                                    const canAct = me?.alive && room.phase !== MAFIA_PHASES.WAITING;
                                    return (
                                        <div>
                                            <div className="card" style={{background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white'}}>
                                                <h1 style={{marginBottom: '10px'}}>üé≠ {room.name}</h1>
                                                <p>Î∞©Ïû•: {room.players[room.host]?.nickname} | Ï∞∏Í∞ÄÏûê: {Object.keys(room.players).length}/{room.maxPlayers}Î™Ö</p>
                                            </div>
                                            {room.winner && (
                                                <div className={`mafia-result ${room.winner === 'MAFIA' ? 'result-mafia-win' : 'result-citizen-win'}`}>
                                                    {room.winner === 'MAFIA' ? 'üî™ ÎßàÌîºÏïÑÌåÄ ÏäπÎ¶¨!' : 'üéâ ÏãúÎØºÌåÄ ÏäπÎ¶¨!'}
                                                    <div style={{fontSize: '1.2rem', marginTop: '15px'}}>Í≤åÏûÑÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§</div>
                                                </div>
                                            )}
                                            {room.phase !== MAFIA_PHASES.WAITING && (
                                                <>
                                                    <div className={`mafia-phase phase-${room.phase}`}>
                                                        {room.phase === MAFIA_PHASES.DAY && `‚òÄÔ∏è ${room.day}ÏùºÏ∞® ÎÇÆ`}
                                                        {room.phase === MAFIA_PHASES.VOTE && 'üó≥Ô∏è Ìà¨Ìëú ÏãúÍ∞Ñ'}
                                                        {room.phase === MAFIA_PHASES.NIGHT && 'üåô Î∞§'}
                                                    </div>
                                                    <div className="mafia-timer">‚è±Ô∏è {Math.floor(mafiaTimeLeft / 60)}:{String(mafiaTimeLeft % 60).padStart(2, '0')}</div>
                                                </>
                                            )}
                                            {room.phase === MAFIA_PHASES.WAITING && <div className="mafia-phase phase-waiting">‚è∏Ô∏è Í≤åÏûÑ ÎåÄÍ∏∞Ï§ë</div>}
                                            {myRole && (
                                                <div className="card" style={{background: '#e3f2fd', border: '2px solid #2196f3'}}>
                                                    <h2 style={{marginBottom: '10px', color: '#1976d2'}}>üé≠ ÎãπÏã†Ïùò Ïó≠Ìï†</h2>
                                                    <div style={{fontSize: '2.5rem', textAlign: 'center', margin: '15px 0'}}>{myRole.emoji} {myRole.name}</div>
                                                    <p style={{textAlign: 'center', color: '#555', fontSize: '1.1rem'}}>{myRole.description}</p>
                                                    {me.role === 'MAFIA' && (
                                                        <div className="danger-box" style={{marginTop: '15px'}}>
                                                            <p><strong>ÎèôÎ£å ÎßàÌîºÏïÑ:</strong> {
                                                                Object.entries(room.players).filter(([id, p]) => p.role === 'MAFIA' && id !== myMafiaId)
                                                                    .map(([_, p]) => p.nickname).join(', ') || 'ÏóÜÏùå (ÌòºÏûêÏûÖÎãàÎã§!)'
                                                            }</p>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            <div className="card">
                                                <h2 style={{marginBottom: '15px'}}>üë• ÌîåÎ†àÏù¥Ïñ¥ ({alivePlayers.length}Î™Ö ÏÉùÏ°¥ / {Object.keys(room.players).length}Î™Ö)</h2>
                                                <div className="mafia-player-grid">
                                                    {Object.entries(room.players).map(([playerId, player]) => {
                                                        const isMe = playerId === myMafiaId;
                                                        const isSelected = mafiaSelectedPlayer === playerId;
                                                        const canSelect = canAct && player.alive && !isMe && 
                                                            ((room.phase === MAFIA_PHASES.VOTE) || 
                                                             (room.phase === MAFIA_PHASES.NIGHT && me.role !== 'CITIZEN'));
                                                        return (
                                                            <div key={playerId} className={`mafia-player-card ${!player.alive ? 'dead' : ''} ${isSelected ? 'selected' : ''} ${isMe ? 'me' : ''}`}
                                                                onClick={() => canSelect && setMafiaSelectedPlayer(isSelected ? '' : playerId)}
                                                                style={{cursor: canSelect ? 'pointer' : 'default'}}>
                                                                {isHost && !isMe && room.phase === MAFIA_PHASES.WAITING && (
                                                                    <button className="kick-btn" onClick={(e) => { e.stopPropagation(); kickMafiaPlayer(playerId); }}>‚úï</button>
                                                                )}
                                                                <div style={{fontSize: '2rem', marginBottom: '8px'}}>{player.alive ? 'üòä' : 'üíÄ'}</div>
                                                                <div style={{fontWeight: 'bold', marginBottom: '5px', fontSize: '1rem'}}>{player.nickname}{isMe && ' (ÎÇò)'}</div>
                                                                <div style={{fontSize: '0.85rem', opacity: 0.7}}>{player.alive ? '‚úÖ ÏÉùÏ°¥' : '‚ùå ÏÇ¨Îßù'}</div>
                                                                {!player.alive && player.role && (
                                                                    <div className={`mafia-role-badge ${MAFIA_ROLES[player.role].color}`}>
                                                                        {MAFIA_ROLES[player.role].emoji} {MAFIA_ROLES[player.role].name}
                                                                    </div>
                                                                )}
                                                                {room.phase === MAFIA_PHASES.WAITING && !isHost && (
                                                                    <div style={{marginTop: '8px', fontSize: '0.9rem'}}>
                                                                        {player.ready ? '‚úÖ Ï§ÄÎπÑ' : '‚è∏Ô∏è ÎåÄÍ∏∞'}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                                {mafiaSelectedPlayer && (
                                                    <div style={{marginTop: '20px'}}>
                                                        {room.phase === MAFIA_PHASES.VOTE && (
                                                            <button className="btn btn-danger" onClick={() => voteMafiaPlayer(mafiaSelectedPlayer)}>
                                                                üó≥Ô∏è {room.players[mafiaSelectedPlayer].nickname}ÎãòÏóêÍ≤å Ìà¨ÌëúÌïòÍ∏∞
                                                            </button>
                                                        )}
                                                        {room.phase === MAFIA_PHASES.NIGHT && me.role !== 'CITIZEN' && (
                                                            <button className="btn" onClick={() => useMafiaNightAbility(mafiaSelectedPlayer)}
                                                                style={{background: me.role === 'MAFIA' ? '#e74c3c' : me.role === 'DOCTOR' ? '#2ecc71' : '#f39c12'}}>
                                                                {me.role === 'MAFIA' && `üî™ ${room.players[mafiaSelectedPlayer].nickname}Îãò Ï†úÍ±∞`}
                                                                {me.role === 'DOCTOR' && `‚öïÔ∏è ${room.players[mafiaSelectedPlayer].nickname}Îãò Î≥¥Ìò∏`}
                                                                {me.role === 'POLICE' && `üîç ${room.players[mafiaSelectedPlayer].nickname}Îãò Ï°∞ÏÇ¨`}
                                                            </button>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="card">
                                                <h2 style={{marginBottom: '15px'}}>üí¨ Ï±ÑÌåÖ</h2>
                                                <div className="mafia-chat" ref={mafiaChatRef}>
                                                    {mafiaMessages.map((msg) => {
                                                        if (msg.private && msg.targetId !== myMafiaId) return null;
                                                        if (msg.isMafia && me.role !== 'MAFIA') return null;
                                                        return (
                                                            <div key={msg.id} className={`mafia-message ${msg.system ? 'system' : ''} ${msg.private ? 'private' : ''}`}>
                                                                {msg.system ? (<div style={{fontWeight: 'bold'}}>{msg.text}</div>) : msg.private ? (
                                                                    <><div className="mafia-message-header">üîí ÎπÑÎ∞Ä Î©îÏãúÏßÄ</div><div>{msg.text}</div></>
                                                                ) : (
                                                                    <><div className="mafia-message-header">{msg.isMafia && 'üî™ [ÎßàÌîºÏïÑ] '}{msg.player}</div><div>{msg.text}</div></>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                                {me?.alive && (room.phase !== MAFIA_PHASES.NIGHT || me.role === 'MAFIA') && (
                                                    <div style={{display: 'flex', gap: '10px'}}>
                                                        <input type="text" value={mafiaChatInput} onChange={(e) => setMafiaChatInput(e.target.value)}
                                                            onKeyPress={(e) => e.key === 'Enter' && sendMafiaMessage()}
                                                            placeholder={me.role === 'MAFIA' && room.phase === MAFIA_PHASES.NIGHT ? "ÎßàÌîºÏïÑÎÅºÎ¶¨ ÎåÄÌôî..." : "Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."}
                                                            style={{flex: 1, marginBottom: 0}} />
                                                        <button className="btn" onClick={sendMafiaMessage} style={{width: 'auto', padding: '12px 25px'}}>Ï†ÑÏÜ°</button>
                                                    </div>
                                                )}
                                                {room.phase === MAFIA_PHASES.NIGHT && me?.alive && me.role !== 'MAFIA' && (
                                                    <p style={{textAlign: 'center', color: '#999', fontStyle: 'italic'}}>Î∞§ÏóêÎäî Ï±ÑÌåÖÌï† Ïàò ÏóÜÏäµÎãàÎã§...</p>
                                                )}
                                            </div>
                                            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                                {room.phase === MAFIA_PHASES.WAITING && (
                                                    <>{isHost ? (
                                                        <button className="btn btn-success" onClick={startMafiaGame}>üéÆ Í≤åÏûÑ ÏãúÏûë</button>
                                                    ) : (
                                                        <button className="btn" onClick={toggleMafiaReady} style={{background: me?.ready ? '#95a5a6' : '#3498db'}}>
                                                            {me?.ready ? '‚úÖ Ï§ÄÎπÑ Ï∑®ÏÜå' : '‚è∏Ô∏è Ï§ÄÎπÑÌïòÍ∏∞'}
                                                        </button>
                                                    )}</>
                                                )}
                                                <button className="btn btn-danger" onClick={leaveMafiaRoom}>üö™ Î∞© ÎÇòÍ∞ÄÍ∏∞</button>
                                            </div>
                                        </div>
                                    );
                                })()
                            )}
                        </div>
                    )}
                    {tab === 'board' && (
                        <div>
                            <div className="card">
                                <h3 style={{marginBottom: '15px'}}>Í≤åÏãúÍ∏Ä ÏûëÏÑ±</h3>
                                <input type="text" placeholder="ÏûëÏÑ±Ïûê Ïù¥Î¶Ñ" value={postAuthor} onChange={e=>setPostAuthor(e.target.value)} />
                                <input type="text" placeholder="Ï†úÎ™©" value={postTitle} onChange={e=>setPostTitle(e.target.value)} />
                                <textarea placeholder="ÎÇ¥Ïö©" value={postContent} onChange={e=>setPostContent(e.target.value)} />
                                <button className="btn" onClick={writePost}>üìù ÏûëÏÑ±ÌïòÍ∏∞</button>
                            </div>
                            
                            {posts.map(post => (
                                <div key={post.id} className="post">
                                    <div className="post-header">
                                        <span>{post.author || 'ÏùµÎ™Ö'}</span>
                                        <span>{new Date(post.timestamp).toLocaleString('ko-KR')}</span>
                                    </div>
                                    <h3 style={{marginBottom: '10px', fontSize: '1.3rem'}}>{post.title}</h3>
                                    <p style={{whiteSpace: 'pre-wrap', lineHeight: '1.6'}}>{post.content}</p>
                                    
                                    <div className="post-footer">
                                        {['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üò°'].map(emoji => {
                                            const count = post.reactions ? Object.values(post.reactions).filter(r => r === emoji).length : 0;
                                            const myReaction = post.reactions && post.reactions[myAnonymousId] === emoji;
                                            return (
                                                <button 
                                                    key={emoji}
                                                    className="reaction"
                                                    onClick={() => addReaction(post.id, emoji)}
                                                    style={{
                                                        background: myReaction ? '#e3f2fd' : '#f8f9fa',
                                                        border: myReaction ? '2px solid #2196f3' : '1px solid #e8e8e8'
                                                    }}
                                                >
                                                    {emoji} {count > 0 && count}
                                                </button>
                                            );
                                        })}
                                    </div>
                                    
                                    {post.comments && Object.keys(post.comments).length > 0 && (
                                        <div className="comments">
                                            <h4 style={{marginBottom: '10px', fontSize: '1rem'}}>
                                                üí¨ ÎåìÍ∏Ä {Object.keys(post.comments).length}Í∞ú
                                            </h4>
                                            {Object.entries(post.comments).sort((a,b) => a[1].timestamp - b[1].timestamp).map(([cid, comment]) => (
                                                <div key={cid} className="comment">
                                                    <div className="comment-header">
                                                        ÏùµÎ™Ö{getCommentAuthorNumber(post, comment.authorId)} ¬∑ {new Date(comment.timestamp).toLocaleString('ko-KR')}
                                                    </div>
                                                    <div>{comment.content}</div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    
                                    <div className="comment-input">
                                        <input 
                                            type="text"
                                            placeholder="ÎåìÍ∏Ä ÏûëÏÑ±..."
                                            value={commentInputs[post.id] || ''}
                                            onChange={e => setCommentInputs({...commentInputs, [post.id]: e.target.value})}
                                            onKeyPress={e => e.key === 'Enter' && writeComment(post.id)}
                                            style={{marginBottom: 0}}
                                        />
                                        <button className="btn btn-small" onClick={() => writeComment(post.id)}>ÏûëÏÑ±</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {/* Ï±ÑÌåÖ */}
                    {tab === 'chat' && (
                        <div>
                            <div className="card" style={{background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white'}}>
                                <h3>üí¨ Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖ</h3>
                                <p style={{fontSize: '1.1rem', marginTop: '10px'}}>ÎãπÏã†Ïùò ÎãâÎÑ§ÏûÑ: <strong>{chatNick} üé≤</strong></p>
                            </div>
                            <div className="chat-container" ref={chatRef}>
                                {messages.map(msg => (
                                    <div key={msg.id} className="chat-message">
                                        <div className="chat-header">{msg.nickname} ¬∑ {new Date(msg.timestamp).toLocaleTimeString('ko-KR')}</div>
                                        <div>{msg.message}</div>
                                    </div>
                                ))}
                            </div>
                            <div style={{display: 'flex', gap: '10px'}}>
                                <input type="text" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•" value={chatMsg} onChange={e=>setChatMsg(e.target.value)} onKeyPress={e=>e.key==='Enter'&&sendChat()} style={{marginBottom: 0}} />
                                <button className="btn" onClick={sendChat} style={{width: 'auto', padding: '12px 30px'}}>Ï†ÑÏÜ°</button>
                            </div>
                        </div>
                    )}
                    
                    {/* Í±∞ÏßìÎßêÌÉêÏßÄÍ∏∞ */}
                    {tab === 'detector' && (
                        <div>
                            <div className="card">
                                <h3 style={{marginBottom: '15px'}}>üîç AI Í±∞ÏßìÎßê ÌÉêÏßÄÍ∏∞</h3>
                                <p style={{color: '#666', marginBottom: '15px'}}>ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÎ©¥ AIÍ∞Ä ÏßÑÏã§/Í±∞ÏßìÏùÑ ÌåêÎã®Ìï©ÎãàÎã§</p>
                                <input 
                                    type="text"
                                    placeholder="ÌåêÎã®Ìï† Î¨∏Ïû•ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                                    value={detectorQuestion}
                                    onChange={e=>setDetectorQuestion(e.target.value)}
                                    onKeyPress={e=>e.key==='Enter'&&!detectorLoading&&detectLie()}
                                />
                                <button className="btn" onClick={detectLie} disabled={detectorLoading || !detectorQuestion.trim()}>
                                    {detectorLoading ? '‚è≥ Î∂ÑÏÑù Ï§ë...' : 'üîç ÏßÑÏã§ Ïó¨Î∂Ä ÌåêÎã®'}
                                </button>
                            </div>
                            
                            {detectorResult && (
                                <div className={`detector-result ${detectorResult.isTrue ? 'true' : 'false'}`}>
                                    <h2 style={{fontSize: '3rem', marginBottom: '20px'}}>
                                        {detectorResult.isTrue ? '‚úÖ ÏßÑÏã§' : '‚ùå Í±∞Ïßì'}
                                    </h2>
                                    <p style={{fontSize: '1.3rem', fontWeight: 'bold', marginBottom: '10px'}}>
                                        {detectorQuestion}
                                    </p>
                                    <p style={{fontSize: '1.1rem', opacity: 0.9}}>
                                        Ïù¥Ïú†: {detectorResult.reason}
                                    </p>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* Ìà¨Ìëú */}
                    {tab === 'poll' && (
                        <div>
                            <div className="card">
                                <h3 style={{marginBottom: '15px'}}>Ìà¨Ìëú ÎßåÎì§Í∏∞</h3>
                                <input type="text" placeholder="ÏßàÎ¨∏" value={pollQuestion} onChange={e=>setPollQuestion(e.target.value)} />
                                {pollOptions.map((opt, idx) => (
                                    <input 
                                        key={idx}
                                        type="text" 
                                        placeholder={`ÏÑ†ÌÉùÏßÄ ${idx+1}`}
                                        value={opt}
                                        onChange={e => {
                                            const newOpts = [...pollOptions];
                                            newOpts[idx] = e.target.value;
                                            setPollOptions(newOpts);
                                        }}
                                    />
                                ))}
                                <button className="btn" onClick={()=>setPollOptions([...pollOptions, ''])} style={{marginBottom: '10px'}}>+ ÏÑ†ÌÉùÏßÄ Ï∂îÍ∞Ä</button>
                                <button className="btn" onClick={createPoll}>üìù Ìà¨Ìëú ÏÉùÏÑ±</button>
                            </div>
                            
                            {polls.map(poll => {
                                const totalVotes = poll.votes ? Object.keys(poll.votes).length : 0;
                                const voteCounts = {};
                                if (poll.votes) {
                                    Object.values(poll.votes).forEach(v => {
                                        voteCounts[v] = (voteCounts[v] || 0) + 1;
                                    });
                                }
                                const myVote = myVotes[poll.id];
                                
                                return (
                                    <div key={poll.id} className="card">
                                        <h3 style={{marginBottom: '15px'}}>{poll.question}</h3>
                                        <p style={{color: '#666', fontSize: '0.9rem', marginBottom: '15px'}}>
                                            Ï¥ù {totalVotes}Ìëú ¬∑ {new Date(poll.timestamp).toLocaleString('ko-KR')}
                                        </p>
                                        {poll.options.map((opt, idx) => {
                                            const count = voteCounts[idx] || 0;
                                            const percent = totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
                                            const isMyVote = myVote === idx;
                                            
                                            return (
                                                <div 
                                                    key={idx}
                                                    style={{
                                                        padding: '15px',
                                                        background: isMyVote ? '#e3f2fd' : '#f8f9fa',
                                                        borderRadius: '8px',
                                                        marginBottom: '10px',
                                                        cursor: 'pointer',
                                                        border: isMyVote ? '2px solid #2196f3' : 'none',
                                                        position: 'relative',
                                                        overflow: 'hidden'
                                                    }}
                                                    onClick={() => vote(poll.id, idx)}
                                                >
                                                    <div style={{
                                                        position: 'absolute',
                                                        left: 0,
                                                        top: 0,
                                                        bottom: 0,
                                                        width: `${percent}%`,
                                                        background: 'rgba(33, 150, 243, 0.1)',
                                                        transition: 'width 0.3s'
                                                    }} />
                                                    <div style={{position: 'relative', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                                        <span style={{fontWeight: isMyVote ? 'bold' : 'normal'}}>
                                                            {isMyVote && '‚úÖ '}{opt}
                                                        </span>
                                                        <span style={{fontWeight: 'bold', color: '#2196f3'}}>
                                                            {count}Ìëú ({percent}%)
                                                        </span>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                    
                    {/* Í≥†Ï∂îÎÜçÏû• */}
                    {tab === 'farm' && (
                        <div>
                            {/* Í≤åÏûÑ Î£∞ ÏÑ§Î™Ö - Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ */}
                            <div className="card" style={{background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white', cursor: 'pointer'}} onClick={()=>setShowRules(!showRules)}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                    <h2 style={{fontSize: '1.5rem'}}>üå∂Ô∏è Í≥†Ï∂îÎÜçÏû• Í≤åÏûÑ Í∞ÄÏù¥Îìú</h2>
                                    <span style={{fontSize: '1.5rem', fontWeight: 'bold'}}>
                                        {showRules ? '‚ñ≤' : '‚ñº'}
                                    </span>
                                </div>
                                <p style={{fontSize: '0.9rem', opacity: 0.9, marginTop: '5px'}}>
                                    {showRules ? 'ÌÅ¥Î¶≠ÌïòÏó¨ Ï†ëÍ∏∞' : 'ÌÅ¥Î¶≠ÌïòÏó¨ Í≤åÏûÑ Î∞©Î≤ï Î≥¥Í∏∞'}
                                </p>
                                
                                {showRules && (
                                    <div style={{marginTop: '20px'}} onClick={e=>e.stopPropagation()}>
                                        <div style={{background: 'rgba(255,255,255,0.1)', padding: '20px', borderRadius: '12px', marginBottom: '15px'}}>
                                            <h3 style={{marginBottom: '10px', fontSize: '1.3rem'}}>üéÆ Í≤åÏûÑ Î™©Ìëú</h3>
                                            <p style={{lineHeight: '1.6', fontSize: '1.05rem'}}>
                                                Í≥†Ï∂îÎ•º ÌÇ§ÏõåÏÑú <strong>1Îì±</strong>ÏùÑ Ï∞®ÏßÄÌïòÏÑ∏Ïöî!<br/>
                                                Ï∂úÏÑùÏ≤¥ÌÅ¨ÏôÄ PVP Î∞∞ÌãÄÎ°ú ÏÑ±Ïû•Ìï† Ïàò ÏûàÏäµÎãàÎã§.
                                            </p>
                                        </div>
                                        
                                        <div style={{background: 'rgba(255,255,255,0.1)', padding: '20px', borderRadius: '12px', marginBottom: '15px'}}>
                                            <h3 style={{marginBottom: '10px', fontSize: '1.3rem'}}>üå± ÏãúÏûë</h3>
                                            <p style={{lineHeight: '1.6', fontSize: '1.05rem'}}>
                                                ‚Ä¢ ÌöåÏõêÍ∞ÄÏûÖ Ïãú <strong>10cm</strong>Î°ú ÏãúÏûë<br/>
                                                ‚Ä¢ ÎãâÎÑ§ÏûÑÏùÄ Ï§ëÎ≥µ Î∂àÍ∞Ä<br/>
                                                ‚Ä¢ ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 4Ïûê Ïù¥ÏÉÅ
                                            </p>
                                        </div>
                                        
                                        <div style={{background: 'rgba(255,255,255,0.1)', padding: '20px', borderRadius: '12px', marginBottom: '15px'}}>
                                            <h3 style={{marginBottom: '10px', fontSize: '1.3rem'}}>‚≠ê Ï∂úÏÑùÏ≤¥ÌÅ¨</h3>
                                            <p style={{lineHeight: '1.6', fontSize: '1.05rem'}}>
                                                ‚Ä¢ <strong>24ÏãúÍ∞ÑÎßàÎã§</strong> 1Ìöå Í∞ÄÎä•<br/>
                                                ‚Ä¢ <strong>1~100cm</strong> ÎûúÎç§ ÏÑ±Ïû•! üé≤<br/>
                                                ‚Ä¢ Ïö¥Ïù¥ Ï¢ãÏúºÎ©¥ 100cm ÎåÄÎ∞ï!<br/>
                                                ‚Ä¢ ÌÉÄÏù¥Î®∏Î°ú ÎÇ®ÏùÄ ÏãúÍ∞Ñ ÌôïÏù∏ Í∞ÄÎä•<br/>
                                                ‚Ä¢ Ï±ÑÌåÖÏóê ÏûêÎèôÏúºÎ°ú Î∞úÌëúÎê®
                                            </p>
                                        </div>
                                        
                                        <div style={{background: 'rgba(255,255,255,0.1)', padding: '20px', borderRadius: '12px', marginBottom: '15px'}}>
                                            <h3 style={{marginBottom: '10px', fontSize: '1.3rem'}}>‚öîÔ∏è Ïò§Ìîà Î∞∞ÌãÄ ÏãúÏä§ÌÖú</h3>
                                            <p style={{lineHeight: '1.6', fontSize: '1.05rem'}}>
                                                ‚Ä¢ Î∞∞ÌãÄ Í∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏó¨ <strong>Ïò§Ìîà Î∞∞ÌãÄ Ïã†Ï≤≠</strong><br/>
                                                ‚Ä¢ <strong>ÎàÑÍµ¨ÎÇò</strong> Î∞∞ÌãÄÏùÑ ÏàòÎùΩÌï† Ïàò ÏûàÏùå (ÏÑ†Ï∞©Ïàú!)<br/>
                                                ‚Ä¢ ÏàòÎùΩÌïòÎ†§Î©¥ Î∞∞ÌãÄ Í∏àÏï° Ïù¥ÏÉÅÏùò Í∏∏Ïù¥ ÌïÑÏöî<br/>
                                                ‚Ä¢ ÏäπÎ•†ÏùÄ <strong>50%</strong> (ÏôÑÏ†Ñ ÎûúÎç§!)<br/>
                                                ‚Ä¢ Ïù¥Í∏∞Î©¥ Î∞∞ÌãÄ Í∏àÏï°ÏùÑ ÌöçÎìù<br/>
                                                ‚Ä¢ ÏßÄÎ©¥ Î∞∞ÌãÄ Í∏àÏï°ÏùÑ ÏûÉÏùå<br/>
                                                ‚Ä¢ Í∏∏Ïù¥Í∞Ä Î∂ÄÏ°±ÌïòÎ©¥ ÏûêÎèô Ï∑®ÏÜåÎê®<br/>
                                                ‚Ä¢ Î∞∞ÌãÄ Í≤∞Í≥ºÎäî Ï±ÑÌåÖÏóê ÏûêÎèô Î∞úÌëú<br/>
                                                ‚Ä¢ ÎÇ¥Í∞Ä Ïã†Ï≤≠Ìïú Î∞∞ÌãÄÏùÄ ÏßÅÏ†ë Ï∑®ÏÜå Í∞ÄÎä•
                                            </p>
                                        </div>
                                        
                                        <div style={{background: 'rgba(255,255,255,0.1)', padding: '20px', borderRadius: '12px', marginBottom: '15px'}}>
                                            <h3 style={{marginBottom: '10px', fontSize: '1.3rem'}}>üèÜ Îû≠ÌÇπ ÏãúÏä§ÌÖú</h3>
                                            <p style={{lineHeight: '1.6', fontSize: '1.05rem'}}>
                                                ‚Ä¢ Ïã§ÏãúÍ∞Ñ ÏàúÏúÑ ÌëúÏãú<br/>
                                                ‚Ä¢ 1ÏúÑ ü•á / 2ÏúÑ ü•à / 3ÏúÑ ü•â<br/>
                                                ‚Ä¢ ÎÇ¥ ÏàúÏúÑÎäî ÌååÎûÄÏÉâÏúºÎ°ú ÌëúÏãú<br/>
                                                ‚Ä¢ Í∏∏Ïù¥ ÏàúÏúºÎ°ú ÏûêÎèô Ï†ïÎ†¨
                                            </p>
                                        </div>
                                        
                                        <div style={{background: 'rgba(255,255,255,0.1)', padding: '20px', borderRadius: '12px'}}>
                                            <h3 style={{marginBottom: '10px', fontSize: '1.3rem'}}>üí° ÌåÅ</h3>
                                            <p style={{lineHeight: '1.6', fontSize: '1.05rem'}}>
                                                ‚Ä¢ Îß§Ïùº Ï∂úÏÑùÏ≤¥ÌÅ¨ÌïòÎ©¥ Íæ∏Ï§ÄÌûà ÏÑ±Ïû•!<br/>
                                                ‚Ä¢ Ïò§Ìîà Î∞∞ÌãÄÏùÄ Ïã†Ï§ëÌïòÍ≤å! ÏûòÎ™ªÌïòÎ©¥ Í∏∏Ïù¥ Í∞êÏÜå<br/>
                                                ‚Ä¢ Ï±ÑÌåÖ ÌÉ≠ÏóêÏÑú Îã§Î•∏ Ïú†Ï†Ä Î∞∞ÌãÄ ÌôïÏù∏ Í∞ÄÎä•<br/>
                                                ‚Ä¢ Í∏∏Ïù¥Í∞Ä Ï∂©Î∂ÑÌïòÎ©¥ ÌÅ∞ Í∏àÏï° Î∞∞ÌãÄ Ïã†Ï≤≠!<br/>
                                                ‚Ä¢ ÏÑ†Ï∞©ÏàúÏù¥Îãà Îπ†Î•¥Í≤å ÏàòÎùΩÌïòÏÑ∏Ïöî!
                                            </p>
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            {!farmUser ? (
                                <div className="card" style={{maxWidth: '500px', margin: '0 auto'}}>
                                    <h2 style={{textAlign: 'center', marginBottom: '20px'}}>üå∂Ô∏è Í≥†Ï∂îÎÜçÏû• {isLogin ? 'Î°úÍ∑∏Ïù∏' : 'ÌöåÏõêÍ∞ÄÏûÖ'}</h2>
                                    <input type="text" placeholder="ÎãâÎÑ§ÏûÑ" value={farmNick} onChange={e=>setFarmNick(e.target.value)} />
                                    <input type="password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ (4Ïûê Ïù¥ÏÉÅ)" value={farmPass} onChange={e=>setFarmPass(e.target.value)} onKeyPress={e=>e.key==='Enter'&&(isLogin?login():register())} />
                                    <button className="btn" onClick={isLogin ? login : register} disabled={!farmNick.trim() || !farmPass.trim()}>
                                        {isLogin ? 'üö™ Î°úÍ∑∏Ïù∏' : 'üå± ÌöåÏõêÍ∞ÄÏûÖ'}
                                    </button>
                                    <div style={{textAlign: 'center', marginTop: '15px'}}>
                                        <button onClick={()=>setIsLogin(!isLogin)} style={{background: 'none', border: 'none', color: '#4a90e2', cursor: 'pointer', textDecoration: 'underline'}}>
                                            {isLogin ? 'ÌöåÏõêÍ∞ÄÏûÖÌïòÍ∏∞' : 'Î°úÍ∑∏Ïù∏ÌïòÍ∏∞'}
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                <div>
                                    {pvpResult && (
                                        <div className={`pvp-result ${pvpResult.isWin ? 'win' : 'lose'}`}>
                                            <h2 style={{fontSize: '2.5rem', marginBottom: '15px'}}>
                                                {pvpResult.isWin ? 'üéâ ÏäπÎ¶¨!' : 'üò¢ Ìå®Î∞∞...'}
                                            </h2>
                                            <p style={{fontSize: '1.3rem', fontWeight: 'bold'}}>
                                                {pvpResult.winner} vs {pvpResult.loser}
                                            </p>
                                            <p style={{fontSize: '1.1rem', marginTop: '10px'}}>
                                                {pvpResult.amount}cm Ïù¥Îèô!
                                            </p>
                                        </div>
                                    )}
                                    
                                    <div className="card" style={{background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white'}}>
                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                                            <h2>{farmUser.nickname}ÎãòÏùò ÎÜçÏû•</h2>
                                            <button onClick={logout} style={{background: 'rgba(255,255,255,0.2)', border: '1px solid white', color: 'white', padding: '8px 20px', borderRadius: '20px', cursor: 'pointer'}}>üö™ Î°úÍ∑∏ÏïÑÏõÉ</button>
                                        </div>
                                        <div style={{fontSize: '4rem', textAlign: 'center', margin: '20px 0'}}>üå∂Ô∏è</div>
                                        <div style={{fontSize: '3rem', fontWeight: 'bold', textAlign: 'center', marginBottom: '20px'}}>{farmUser.length}cm</div>
                                        <div style={{background: 'rgba(255,255,255,0.2)', padding: '20px', borderRadius: '12px', textAlign: 'center', marginBottom: '20px'}}>
                                            <div style={{fontSize: '1.5rem', fontWeight: 'bold'}}>‚è∞ {timer}</div>
                                        </div>
                                        <button className="btn" onClick={checkIn} disabled={timer !== 'Ï∂úÏÑù Í∞ÄÎä•!'} style={{background: timer === 'Ï∂úÏÑù Í∞ÄÎä•!' ? 'white' : 'rgba(255,255,255,0.3)', color: timer === 'Ï∂úÏÑù Í∞ÄÎä•!' ? '#667eea' : 'rgba(255,255,255,0.7)'}}>
                                            ‚≠ê Ï∂úÏÑùÏ≤¥ÌÅ¨ (1~100cm)
                                        </button>
                                    </div>
                                    
                                    {pvpReqs.length > 0 && (
                                        <div className="card">
                                            <h3 style={{marginBottom: '15px'}}>‚öîÔ∏è Ïò§Ìîà Î∞∞ÌãÄ Î™©Î°ù</h3>
                                            <p style={{color: '#666', fontSize: '0.9rem', marginBottom: '15px'}}>
                                                ÎàÑÍµ¨ÎÇò ÏàòÎùΩÌï† Ïàò ÏûàÎäî Î∞∞ÌãÄ Î™©Î°ùÏûÖÎãàÎã§!
                                            </p>
                                            {pvpReqs.map(req => {
                                                const isMyBattle = req.fromId === farmUser.id;
                                                const canAccept = !isMyBattle && farmUser.length >= req.amount;
                                                
                                                return (
                                                    <div key={req.id} style={{
                                                        padding: '15px',
                                                        background: isMyBattle ? '#fff3cd' : '#f8f9fa',
                                                        borderRadius: '8px',
                                                        marginBottom: '10px',
                                                        border: isMyBattle ? '2px solid #ffc107' : 'none'
                                                    }}>
                                                        <div style={{marginBottom: '10px'}}>
                                                            <div style={{fontWeight: 'bold', fontSize: '1.1rem', marginBottom: '5px'}}>
                                                                {isMyBattle ? 'üî∂ ÎÇ¥ Î∞∞ÌãÄ' : '‚öîÔ∏è'} {req.fromName}ÎãòÏùò Î∞∞ÌãÄ
                                                            </div>
                                                            <div style={{color: '#666', fontSize: '0.95rem'}}>
                                                                Î∞∞ÌåÖ Í∏àÏï°: <strong style={{color: '#f44336', fontSize: '1.1rem'}}>{req.amount}cm</strong>
                                                            </div>
                                                            <div style={{color: '#999', fontSize: '0.85rem', marginTop: '5px'}}>
                                                                {new Date(req.timestamp).toLocaleString('ko-KR')}
                                                            </div>
                                                        </div>
                                                        
                                                        {isMyBattle ? (
                                                            <button
                                                                className="btn"
                                                                onClick={()=>cancelPvp(req.id)}
                                                                style={{
                                                                    background: 'linear-gradient(135deg, #f44336 0%, #ef5350 100%)'
                                                                }}
                                                            >
                                                                ‚ùå Ï∑®ÏÜå
                                                            </button>
                                                        ) : (
                                                            <button
                                                                className="btn"
                                                                onClick={()=>acceptPvp(req)}
                                                                disabled={!canAccept}
                                                                style={{
                                                                    background: canAccept 
                                                                        ? 'linear-gradient(135deg, #4caf50 0%, #66bb6a 100%)' 
                                                                        : '#ccc',
                                                                    cursor: canAccept ? 'pointer' : 'not-allowed'
                                                                }}
                                                            >
                                                                {canAccept ? '‚úÖ ÏàòÎùΩ' : `üîí ÏàòÎùΩ Î∂àÍ∞Ä (${req.amount}cm ÌïÑÏöî)`}
                                                            </button>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                    
                                    <div className="card">
                                        <h3 style={{marginBottom: '15px'}}>‚öîÔ∏è Ïò§Ìîà Î∞∞ÌãÄ Ïã†Ï≤≠</h3>
                                        <p style={{color: '#666', fontSize: '0.9rem', marginBottom: '15px'}}>
                                            Î∞∞ÌãÄ Í∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÎ©¥ ÎàÑÍµ¨ÎÇò ÏàòÎùΩÌï† Ïàò ÏûàÎäî Ïò§Ìîà Î∞∞ÌãÄÏù¥ ÏÉùÏÑ±Îê©ÎãàÎã§!<br/>
                                            <strong style={{color: '#4a90e2'}}>ÌòÑÏû¨ ÏÇ¨Ïö© Í∞ÄÎä•: {farmUser.length}cm</strong>
                                        </p>
                                        <input 
                                            type="number" 
                                            placeholder={`Í±∏ cm (ÏµúÎåÄ ${farmUser.length}cm)`}
                                            value={pvpAmount} 
                                            onChange={e=>setPvpAmount(e.target.value)} 
                                            min="1"
                                            max={farmUser.length}
                                        />
                                        <button 
                                            className="btn" 
                                            onClick={sendPvp} 
                                            disabled={!pvpAmount}
                                        >
                                            ‚öîÔ∏è Ïò§Ìîà Î∞∞ÌãÄ Ïã†Ï≤≠
                                        </button>
                                    </div>
                                    
                                    <div className="card">
                                        <h3 style={{marginBottom: '15px'}}>üèÜ Îû≠ÌÇπ</h3>
                                        {allUsers.map((user, idx) => {
                                            const userGrade = getGrade(user.length);
                                            return (
                                                <div key={user.id} style={{padding: '15px', background: user.id === farmUser.id ? '#e3f2fd' : '#f8f9fa', borderRadius: '8px', marginBottom: '10px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', border: user.id === farmUser.id ? '2px solid #2196f3' : 'none'}}>
                                                    <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                                        <span style={{fontSize: '1.5rem', fontWeight: 'bold', color: idx === 0 ? '#ffd700' : idx === 1 ? '#c0c0c0' : idx === 2 ? '#cd7f32' : '#999'}}>{idx + 1}</span>
                                                        <div>
                                                            <div style={{display: 'flex', alignItems: 'center', gap: '5px'}}>
                                                                <span style={{fontWeight: 'bold', fontSize: '1.05rem'}}>{user.nickname}</span>
                                                                {user.id === farmUser.id && <span style={{background: '#2196f3', color: 'white', padding: '2px 8px', borderRadius: '10px', fontSize: '0.75rem'}}>ÎÇò</span>}
                                                            </div>
                                                            <div style={{fontSize: '0.85rem', color: userGrade.color, fontWeight: '600', marginTop: '2px'}}>
                                                                {userGrade.emoji} {userGrade.name}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div style={{fontSize: '1.3rem', fontWeight: 'bold', color: '#4caf50'}}>üå∂Ô∏è {user.length}cm</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* Í≥†Ï∂îÎåÄÏû•Í∞Ñ */}
                    {tab === 'forge' && (
                        <div>
                            {!farmUser ? (
                                <div className="card" style={{textAlign: 'center', padding: '60px 20px'}}>
                                    <h2 style={{fontSize: '3rem', marginBottom: '20px'}}>üî®</h2>
                                    <h3 style={{marginBottom: '15px', fontSize: '1.5rem'}}>Í≥†Ï∂îÎÜçÏû•Ïóê Î®ºÏ†Ä Î°úÍ∑∏Ïù∏ÌïòÏÑ∏Ïöî!</h3>
                                    <p style={{color: '#666', marginBottom: '20px'}}>
                                        Í∞ïÌôî Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©ÌïòÎ†§Î©¥ ÎÜçÏû• Í≥ÑÏ†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.
                                    </p>
                                    <button className="btn" onClick={()=>setTab('farm')}>
                                        üå∂Ô∏è Í≥†Ï∂îÎÜçÏû•ÏúºÎ°ú Í∞ÄÍ∏∞
                                    </button>
                                </div>
                            ) : (
                                <div>
                                    {forgeResult && (
                                        <div className={`pvp-result ${forgeResult.success ? 'win' : 'lose'}`}>
                                            <h2 style={{fontSize: '2.5rem', marginBottom: '15px'}}>
                                                {forgeResult.success ? '‚ú® Í∞ïÌôî ÏÑ±Í≥µ!' : 'üí• Í∞ïÌôî Ïã§Ìå®...'}
                                            </h2>
                                            <p style={{fontSize: '1.3rem', fontWeight: 'bold', marginBottom: '10px'}}>
                                                {forgeResult.oldGrade.emoji} {forgeResult.oldGrade.name} ({forgeResult.oldLength}cm)
                                            </p>
                                            <p style={{fontSize: '2rem', marginBottom: '10px'}}>‚Üì</p>
                                            <p style={{fontSize: '1.3rem', fontWeight: 'bold'}}>
                                                {forgeResult.newGrade.emoji} {forgeResult.newGrade.name} ({forgeResult.newLength}cm)
                                            </p>
                                            <p style={{fontSize: '1.1rem', marginTop: '15px', opacity: 0.9}}>
                                                {forgeResult.success ? `+${forgeResult.change}cm` : `${forgeResult.change}cm`}
                                            </p>
                                        </div>
                                    )}
                                    
                                    <div className="card" style={{background: 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)', color: 'white'}}>
                                        <h2 style={{marginBottom: '20px', fontSize: '1.8rem'}}>üî® Í≥†Ï∂îÎåÄÏû•Í∞Ñ</h2>
                                        
                                        <div style={{background: 'rgba(255,255,255,0.2)', padding: '20px', borderRadius: '12px', marginBottom: '20px'}}>
                                            <div style={{fontSize: '4rem', textAlign: 'center', marginBottom: '15px'}}>
                                                {getGrade(farmUser.length).emoji}
                                            </div>
                                            <div style={{textAlign: 'center', marginBottom: '10px'}}>
                                                <div style={{fontSize: '1.8rem', fontWeight: 'bold', marginBottom: '5px'}}>
                                                    {getGrade(farmUser.length).name}
                                                </div>
                                                <div style={{fontSize: '2.5rem', fontWeight: 'bold'}}>
                                                    {farmUser.length}cm
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div style={{background: 'rgba(255,255,255,0.2)', padding: '20px', borderRadius: '12px', marginBottom: '20px'}}>
                                            <h3 style={{marginBottom: '15px', fontSize: '1.3rem'}}>‚öíÔ∏è Í∞ïÌôî Ï†ïÎ≥¥</h3>
                                            <p style={{lineHeight: '1.8', fontSize: '1.05rem'}}>
                                                ‚Ä¢ Í∞ïÌôî ÎπÑÏö©: <strong style={{fontSize: '1.3rem', color: '#ffeb3b'}}>{getForgeCost(farmUser.length)}cm</strong><br/>
                                                ‚Ä¢ ÏÑ±Í≥µ Ïãú: <strong style={{fontSize: '1.2rem', color: '#4caf50'}}>+{getForgeBonus(farmUser.length).min}~{getForgeBonus(farmUser.length).max}cm ÌöçÎìù</strong><br/>
                                                ‚Ä¢ Ïã§Ìå® Ïãú: <strong style={{fontSize: '1.1rem', color: '#f44336'}}>-{getForgeLoss(farmUser.length).small}~{getForgeLoss(farmUser.length).big}cm ÏÜêÏã§ ÎòêÎäî ÌååÍ¥¥</strong><br/>
                                                ‚Ä¢ ÌòÑÏû¨ ÏÑ±Í≥µ ÌôïÎ•†: <strong style={{fontSize: '1.3rem', color: getSuccessRate(farmUser.length) >= 80 ? '#4caf50' : getSuccessRate(farmUser.length) >= 50 ? '#ffeb3b' : '#ff9800'}}>{getSuccessRate(farmUser.length)}%</strong><br/>
                                                ‚Ä¢ <strong style={{fontSize: '1.1rem', color: getDestroyRate(farmUser.length) >= 3 ? '#d32f2f' : getDestroyRate(farmUser.length) >= 1 ? '#ff6b6b' : '#999'}}>‚ö†Ô∏è ÌååÍ¥¥ ÌôïÎ•†: {getDestroyRate(farmUser.length)}%</strong>
                                            </p>
                                        </div>
                                        
                                        <button 
                                            className="btn" 
                                            onClick={tryForge}
                                            disabled={forging || farmUser.length < getForgeCost(farmUser.length)}
                                            style={{
                                                background: forging ? 'rgba(255,255,255,0.3)' : 'white',
                                                color: forging ? 'rgba(255,255,255,0.7)' : '#ff6b6b',
                                                fontSize: '1.2rem',
                                                padding: '18px'
                                            }}
                                        >
                                            {forging ? '‚è≥ Í∞ïÌôî Ï§ë...' : `üî® Í∞ïÌôî ÏãúÎèÑ (-${getForgeCost(farmUser.length)}cm)`}
                                        </button>
                                        
                                        {farmUser.length < getForgeCost(farmUser.length) && (
                                            <p style={{textAlign: 'center', marginTop: '15px', fontSize: '0.9rem', opacity: 0.9}}>
                                                ‚ö†Ô∏è Í∞ïÌôî ÎπÑÏö©Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§! (ÌïÑÏöî: {getForgeCost(farmUser.length)}cm, ÌòÑÏû¨: {farmUser.length}cm)
                                            </p>
                                        )}
                                    </div>
                                    
                                    <div className="card">
                                        <h3 style={{marginBottom: '15px'}}>üìä Îì±Í∏â ÏãúÏä§ÌÖú (Ï¥ù 20Îã®Í≥Ñ)</h3>
                                        {[
                                            { min: 0, max: 20, ...getGrade(10), rate: 97, cost: 10, destroy: 0.01 },
                                            { min: 21, max: 40, ...getGrade(30), rate: 95, cost: 10, destroy: 0.05 },
                                            { min: 41, max: 60, ...getGrade(50), rate: 93, cost: 11, destroy: 0.1 },
                                            { min: 61, max: 80, ...getGrade(70), rate: 91, cost: 13, destroy: 0.15 },
                                            { min: 81, max: 100, ...getGrade(90), rate: 89, cost: 15, destroy: 0.2 },
                                            { min: 101, max: 130, ...getGrade(115), rate: 87, cost: 18, destroy: 0.3 },
                                            { min: 131, max: 160, ...getGrade(145), rate: 85, cost: 20, destroy: 0.4 },
                                            { min: 161, max: 200, ...getGrade(180), rate: 82, cost: 22, destroy: 0.5 },
                                            { min: 201, max: 250, ...getGrade(225), rate: 79, cost: 25, destroy: 0.6 },
                                            { min: 251, max: 300, ...getGrade(275), rate: 76, cost: 30, destroy: 0.8 },
                                            { min: 301, max: 400, ...getGrade(350), rate: 73, cost: 35, destroy: 1.0 },
                                            { min: 401, max: 500, ...getGrade(450), rate: 70, cost: 40, destroy: 1.2 },
                                            { min: 501, max: 650, ...getGrade(575), rate: 65, cost: 50, destroy: 1.5 },
                                            { min: 651, max: 800, ...getGrade(725), rate: 60, cost: 60, destroy: 2.0 },
                                            { min: 801, max: 1000, ...getGrade(900), rate: 55, cost: 70, destroy: 2.5 },
                                            { min: 1001, max: 1300, ...getGrade(1150), rate: 50, cost: 80, destroy: 3.0 },
                                            { min: 1301, max: 1600, ...getGrade(1450), rate: 45, cost: 100, destroy: 3.5 },
                                            { min: 1601, max: 2000, ...getGrade(1800), rate: 40, cost: 120, destroy: 4.0 },
                                            { min: 2001, max: 2500, ...getGrade(2250), rate: 35, cost: 150, destroy: 4.5 },
                                            { min: 2501, max: '‚àû', ...getGrade(3000), rate: 30, cost: 200, destroy: 5.0 }
                                        ].map((grade, idx) => {
                                            const isCurrent = farmUser.length >= grade.min && (grade.max === '‚àû' || farmUser.length <= grade.max);
                                            return (
                                                <div 
                                                    key={idx}
                                                    style={{
                                                        padding: '12px',
                                                        background: isCurrent ? '#e3f2fd' : '#f8f9fa',
                                                        borderRadius: '8px',
                                                        marginBottom: '8px',
                                                        border: isCurrent ? '2px solid #2196f3' : 'none'
                                                    }}
                                                >
                                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '10px'}}>
                                                        <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                                            <span style={{fontSize: '1.5rem'}}>{grade.emoji}</span>
                                                            <div>
                                                                <div style={{fontWeight: 'bold', fontSize: '1rem', color: grade.color}}>
                                                                    {grade.name}
                                                                </div>
                                                                <div style={{fontSize: '0.85rem', color: '#666'}}>
                                                                    {grade.min}~{grade.max}cm
                                                                </div>
                                                            </div>
                                                            {isCurrent && (
                                                                <span style={{background: '#2196f3', color: 'white', padding: '2px 8px', borderRadius: '10px', fontSize: '0.75rem', fontWeight: 'bold'}}>
                                                                    ÌòÑÏû¨
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div style={{textAlign: 'right'}}>
                                                            <div style={{fontSize: '1rem', fontWeight: 'bold', color: grade.rate >= 80 ? '#4caf50' : grade.rate >= 50 ? '#ff9800' : '#f44336'}}>
                                                                ÏÑ±Í≥µÎ•†: {grade.rate}%
                                                            </div>
                                                            <div style={{fontSize: '0.85rem', color: '#666', marginTop: '2px'}}>
                                                                ÎπÑÏö©: {grade.cost}cm
                                                            </div>
                                                            <div style={{fontSize: '0.8rem', color: grade.destroy >= 3 ? '#d32f2f' : grade.destroy >= 1 ? '#ff9800' : '#999', marginTop: '2px'}}>
                                                                ÌååÍ¥¥Ïú®: {grade.destroy}%
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    
                                    <div className="card" style={{background: '#fff3cd', border: '2px solid #ffc107'}}>
                                        <h3 style={{marginBottom: '15px', color: '#856404'}}>‚ö†Ô∏è Í∞ïÌôî ÏãúÏä§ÌÖú ÏïàÎÇ¥</h3>
                                        <p style={{lineHeight: '1.8', color: '#856404', fontWeight: 'bold'}}>
                                            ‚Ä¢ Í∞ïÌôîÎäî <strong style={{color: '#d32f2f'}}>ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§!</strong><br/>
                                            ‚Ä¢ <strong style={{color: '#4caf50'}}>ÎÜíÏùÄ ÏÑ±Í≥µÎ•†!</strong> Ï¥àÎ∞ò 97% ‚Üí Ï§ëÎ∞ò 70% ‚Üí ÏµúÏ¢Ö 30%<br/>
                                            ‚Ä¢ <strong style={{color: '#2196f3'}}>2Î∞∞ Ï¶ùÍ∞ÄÎêú Î≥¥ÏÉÅ!</strong> ÏÑ±Í≥µ Ïãú Ï¥àÎ∞ò 20~40cm ‚Üí ÏµúÏ¢Ö 300~600cm!<br/>
                                            ‚Ä¢ <strong style={{color: '#ff9800'}}>Îì±Í∏âÎ≥Ñ Ï∞®Îì± ÎπÑÏö©!</strong> Ï¥àÎ∞ò 10cm ‚Üí Ï§ëÎ∞ò 40cm ‚Üí ÏµúÏ¢Ö 200cm<br/>
                                            ‚Ä¢ <strong style={{color: '#d32f2f'}}>‚ö†Ô∏è ÌååÍ¥¥ ÏãúÏä§ÌÖú ‚ö†Ô∏è</strong><br/>
                                            ‚Ä¢ Ï¥àÎ∞òÏóêÎäî ÌååÍ¥¥ ÌôïÎ•†Ïù¥ <strong style={{color: '#4caf50'}}>Í±∞Ïùò ÏóÜÏùå (0.01%)</strong><br/>
                                            ‚Ä¢ Ï§ëÎ∞òÎ∂ÄÌÑ∞ ÏÑúÏÑúÌûà Ï¶ùÍ∞Ä: 100cm 0.3% ‚Üí 300cm 1% ‚Üí 500cm 1.5%<br/>
                                            ‚Ä¢ ÌõÑÎ∞ò Í∏âÏ¶ù: 1000cm 3% ‚Üí 2000cm 4.5% ‚Üí <strong style={{color: '#d32f2f'}}>ÏµúÏ¢Ö 5%</strong><br/>
                                            ‚Ä¢ Ïã§Ìå® Ïãú 30% ÌÅ∞ ÏÜêÏã§, ÎÇòÎ®∏ÏßÄÎäî ÏûëÏùÄ ÏÜêÏã§<br/>
                                            ‚Ä¢ <strong style={{fontSize: '1.1rem', color: '#2196f3'}}>High Risk, High Return!</strong><br/>
                                            ‚Ä¢ Ï¥àÎ∞òÏóî Ï†ÅÍ∑π Í∞ïÌôî, ÌõÑÎ∞òÏóî Ïã†Ï§ëÌïòÍ≤å!
                                        </p>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
