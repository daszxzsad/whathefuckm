<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìµëª… ê²Œì‹œíŒ + ë§ˆí”¼ì•„ ê²Œì„</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f7fa; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; padding: 20px; background: white; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); flex-wrap: wrap; }
        .tab { flex: 1; min-width: 80px; padding: 12px; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; background: #f5f7fa; color: #7f8c8d; transition: all 0.3s; }
        .tab.active { background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: white; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input, textarea, select { width: 100%; padding: 12px; border: 2px solid #e8e8e8; border-radius: 8px; font-size: 1rem; margin-bottom: 10px; font-family: inherit; }
        textarea { min-height: 100px; resize: vertical; }
        .btn { width: 100%; padding: 14px; background: #4a90e2; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .btn:hover { background: #357abd; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-small { width: auto; padding: 8px 15px; font-size: 0.9rem; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .btn-success { background: #2ecc71; }
        .btn-success:hover { background: #27ae60; }
        
        /* ë§ˆí”¼ì•„ ê²Œì„ ìŠ¤íƒ€ì¼ */
        .mafia-room-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .mafia-room-card { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .mafia-room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        .mafia-room-header { 
            font-size: 1.3rem; 
            font-weight: bold; 
            margin-bottom: 10px;
        }
        .mafia-room-info { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 0.9rem;
        }
        
        .mafia-player-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 12px; 
            margin: 20px 0;
        }
        .mafia-player-card { 
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e8e8e8;
            transition: all 0.3s;
            cursor: pointer;
        }
        .mafia-player-card:hover {
            background: #e8ecef;
            border-color: #4a90e2;
        }
        .mafia-player-card.dead {
            opacity: 0.5;
            background: #ddd;
        }
        .mafia-player-card.selected {
            border-color: #e74c3c;
            background: #ffe6e6;
        }
        .mafia-player-card.me {
            border-color: #2ecc71;
            background: #e8f8f5;
        }
        
        .mafia-role-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-top: 8px;
        }
        .role-mafia { background: #e74c3c; color: white; }
        .role-citizen { background: #3498db; color: white; }
        .role-doctor { background: #2ecc71; color: white; }
        .role-police { background: #f39c12; color: white; }
        .role-unknown { background: #95a5a6; color: white; }
        
        .mafia-phase {
            text-align: center;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 1.8rem;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        .phase-day { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; }
        .phase-night { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; }
        .phase-vote { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; }
        .phase-waiting { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .mafia-timer {
            text-align: center;
            font-size: 3rem;
            font-weight: bold;
            color: #e74c3c;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }
        
        .mafia-chat {
            height: 350px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #e8e8e8;
        }
        .mafia-message {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #4a90e2;
        }
        .mafia-message.system {
            background: #fff3cd;
            border-left-color: #f39c12;
            font-style: italic;
        }
        .mafia-message.private {
            background: #d4edda;
            border-left-color: #28a745;
        }
        .mafia-message-header {
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .mafia-result {
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            margin: 30px 0;
            animation: fadeIn 0.5s;
            color: white;
        }
        .result-mafia-win {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        .result-citizen-win {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }
        
        .mafia-rules {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #4a90e2;
        }
        .mafia-rules h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        .mafia-rules p {
            line-height: 1.8;
            color: #34495e;
            margin-bottom: 10px;
        }
        .mafia-rules ul {
            list-style: none;
            padding-left: 0;
        }
        .mafia-rules li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }
        .mafia-rules li:before {
            content: "â–ª";
            position: absolute;
            left: 0;
            color: #4a90e2;
            font-weight: bold;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .danger-box {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ë“¤ */
        .post { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .post-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; color: #666; }
        .post-footer { display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0; }
        .reaction { padding: 8px 12px; background: #f8f9fa; border: 1px solid #e8e8e8; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
        .reaction:hover { background: #e8ecef; }
        .comments { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .comment { background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        .comment-header { font-size: 0.85rem; color: #666; margin-bottom: 5px; }
        .comment-input { display: flex; gap: 10px; margin-top: 10px; }
        .chat-container { height: 500px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .chat-message { background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        .chat-header { font-weight: bold; color: #4a90e2; margin-bottom: 5px; font-size: 0.9rem; }
        .detector-result { padding: 30px; border-radius: 12px; margin: 20px 0; text-align: center; animation: fadeIn 0.5s; }
        .detector-result.true { background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); color: white; }
        .detector-result.false { background: linear-gradient(135deg, #f44336 0%, #ef5350 100%); color: white; }
        .pvp-result { padding: 30px; border-radius: 12px; text-align: center; margin-bottom: 20px; color: white; animation: fadeIn 0.5s; }
        .pvp-result.win { background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); }
        .pvp-result.lose { background: linear-gradient(135deg, #f44336 0%, #ef5350 100%); }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyDh3FsyWVZqy8wGExv-IlAglJ0DERuW_T8",
            authDomain: "ccccc-74256.firebaseapp.com",
            databaseURL: "https://ccccc-74256-default-rtdb.firebaseio.com",
            projectId: "ccccc-74256",
            storageBucket: "ccccc-74256.firebasestorage.app",
            messagingSenderId: "1086870817114",
            appId: "1:1086870817114:web:8fb533c96f3402bfe78b63"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        // ë§ˆí”¼ì•„ ê²Œì„ ìƒìˆ˜
        const MAFIA_ROLES = {
            MAFIA: { name: 'ë§ˆí”¼ì•„', emoji: 'ğŸ”ª', color: 'role-mafia', description: 'ë°¤ì— ì‹œë¯¼ì„ ì œê±°í•©ë‹ˆë‹¤' },
            CITIZEN: { name: 'ì‹œë¯¼', emoji: 'ğŸ‘¤', color: 'role-citizen', description: 'í† ë¡ ê³¼ íˆ¬í‘œë¡œ ë§ˆí”¼ì•„ë¥¼ ì°¾ì•„ëƒ…ë‹ˆë‹¤' },
            DOCTOR: { name: 'ì˜ì‚¬', emoji: 'âš•ï¸', color: 'role-doctor', description: 'ë°¤ì— í•œ ëª…ì„ ë§ˆí”¼ì•„ë¡œë¶€í„° ë³´í˜¸í•©ë‹ˆë‹¤' },
            POLICE: { name: 'ê²½ì°°', emoji: 'ğŸ‘®', color: 'role-police', description: 'ë°¤ì— í•œ ëª…ì„ ì¡°ì‚¬í•˜ì—¬ ë§ˆí”¼ì•„ ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤' }
        };

        const MAFIA_PHASES = {
            WAITING: 'waiting',
            DAY: 'day',
            VOTE: 'vote',
            NIGHT: 'night'
        };

        // ì¸ì›ë³„ ì—­í•  ë°°ì • ê·œì¹™
        const getRoleDistribution = (playerCount) => {
            if (playerCount < 4) return null;
            
            const roles = [];
            
            if (playerCount >= 4 && playerCount <= 5) {
                // 4-5ëª…: ë§ˆí”¼ì•„1, ê²½ì°°1, ì‹œë¯¼
                roles.push('MAFIA');
                roles.push('POLICE');
                while (roles.length < playerCount) roles.push('CITIZEN');
            } else if (playerCount >= 6 && playerCount <= 7) {
                // 6-7ëª…: ë§ˆí”¼ì•„2, ê²½ì°°1, ì˜ì‚¬1, ì‹œë¯¼
                roles.push('MAFIA', 'MAFIA');
                roles.push('POLICE');
                roles.push('DOCTOR');
                while (roles.length < playerCount) roles.push('CITIZEN');
            } else if (playerCount >= 8 && playerCount <= 9) {
                // 8-9ëª…: ë§ˆí”¼ì•„2, ê²½ì°°1, ì˜ì‚¬1, ì‹œë¯¼
                roles.push('MAFIA', 'MAFIA');
                roles.push('POLICE');
                roles.push('DOCTOR');
                while (roles.length < playerCount) roles.push('CITIZEN');
            } else if (playerCount >= 10 && playerCount <= 11) {
                // 10-11ëª…: ë§ˆí”¼ì•„3, ê²½ì°°1, ì˜ì‚¬1, ì‹œë¯¼
                roles.push('MAFIA', 'MAFIA', 'MAFIA');
                roles.push('POLICE');
                roles.push('DOCTOR');
                while (roles.length < playerCount) roles.push('CITIZEN');
            } else {
                // 12ëª…+: ë§ˆí”¼ì•„3, ê²½ì°°2, ì˜ì‚¬1, ì‹œë¯¼
                roles.push('MAFIA', 'MAFIA', 'MAFIA');
                roles.push('POLICE', 'POLICE');
                roles.push('DOCTOR');
                while (roles.length < playerCount) roles.push('CITIZEN');
            }
            
            return roles;
        };

        function App() {
            const [tab, setTab] = useState('mafia');
            
            // ë§ˆí”¼ì•„ ê²Œì„
            const [mafiaScreen, setMafiaScreen] = useState('lobby');
            const [mafiaRooms, setMafiaRooms] = useState({});
            const [currentMafiaRoom, setCurrentMafiaRoom] = useState(null);
            const [mafiaMessages, setMafiaMessages] = useState([]);
            const [mafiaChatInput, setMafiaChatInput] = useState('');
            const [mafiaSelectedPlayer, setMafiaSelectedPlayer] = useState('');
            const [mafiaTimeLeft, setMafiaTimeLeft] = useState(0);
            const [myMafiaId, setMyMafiaId] = useState('');
            const [myMafiaNick, setMyMafiaNick] = useState('');
            const [newMafiaRoomName, setNewMafiaRoomName] = useState('');
            const [newMafiaRoomMax, setNewMafiaRoomMax] = useState(8);
            const [showMafiaRules, setShowMafiaRules] = useState(false);
            const mafiaChatRef = useRef(null);

            // Firebase ë¦¬ìŠ¤ë„ˆ - ë§ˆí”¼ì•„ ë°© ëª©ë¡
            useEffect(() => {
                const roomsRef = db.ref('mafia/rooms');
                roomsRef.on('value', (snapshot) => {
                    setMafiaRooms(snapshot.val() || {});
                });
                return () => roomsRef.off();
            }, []);

            // Firebase ë¦¬ìŠ¤ë„ˆ - ë§ˆí”¼ì•„ ì±„íŒ…
            useEffect(() => {
                if (currentMafiaRoom) {
                    const messagesRef = db.ref(`mafia/rooms/${currentMafiaRoom}/messages`);
                    messagesRef.limitToLast(50).on('value', (snapshot) => {
                        const msgs = [];
                        snapshot.forEach((child) => {
                            msgs.push({ id: child.key, ...child.val() });
                        });
                        setMafiaMessages(msgs);
                        setTimeout(() => {
                            if (mafiaChatRef.current) {
                                mafiaChatRef.current.scrollTop = mafiaChatRef.current.scrollHeight;
                            }
                        }, 100);
                    });
                    return () => messagesRef.off();
                }
            }, [currentMafiaRoom]);

            // ë§ˆí”¼ì•„ íƒ€ì´ë¨¸ & ìë™ ì§„í–‰
            useEffect(() => {
                if (!currentMafiaRoom || !mafiaRooms[currentMafiaRoom]) return;
                
                const room = mafiaRooms[currentMafiaRoom];
                if (!room.phaseEndTime || room.phase === MAFIA_PHASES.WAITING) return;

                const interval = setInterval(() => {
                    const now = Date.now();
                    const remaining = Math.max(0, Math.floor((room.phaseEndTime - now) / 1000));
                    setMafiaTimeLeft(remaining);

                    if (remaining === 0) {
                        handleMafiaPhaseEnd();
                    }
                }, 1000);

                return () => clearInterval(interval);
            }, [currentMafiaRoom, mafiaRooms]);

            // ë§ˆí”¼ì•„ ë°© ìƒì„±
            const createMafiaRoom = async () => {
                if (!newMafiaRoomName.trim() || !myMafiaNick.trim()) {
                    alert('ë°© ì´ë¦„ê³¼ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                    return;
                }

                const roomId = 'room_' + Date.now();
                const playerId = 'player_' + Date.now();
                
                await db.ref(`mafia/rooms/${roomId}`).set({
                    name: newMafiaRoomName,
                    maxPlayers: parseInt(newMafiaRoomMax),
                    host: playerId,
                    phase: MAFIA_PHASES.WAITING,
                    players: {
                        [playerId]: {
                            nickname: myMafiaNick,
                            ready: true,
                            alive: true,
                            joinedAt: Date.now()
                        }
                    },
                    createdAt: Date.now()
                });

                setMyMafiaId(playerId);
                setCurrentMafiaRoom(roomId);
                setMafiaScreen('room');
                addMafiaSystemMessage(roomId, `${myMafiaNick}ë‹˜ì´ ë°©ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.`);
            };

            // ë§ˆí”¼ì•„ ë°© ì°¸ê°€
            const joinMafiaRoom = async (roomId) => {
                if (!myMafiaNick.trim()) {
                    alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                    return;
                }

                const room = mafiaRooms[roomId];
                const playerCount = Object.keys(room.players || {}).length;
                
                if (playerCount >= room.maxPlayers) {
                    alert('ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!');
                    return;
                }

                if (room.phase !== MAFIA_PHASES.WAITING) {
                    alert('ì´ë¯¸ ê²Œì„ì´ ì§„í–‰ì¤‘ì…ë‹ˆë‹¤!');
                    return;
                }

                const playerId = 'player_' + Date.now();
                
                await db.ref(`mafia/rooms/${roomId}/players/${playerId}`).set({
                    nickname: myMafiaNick,
                    ready: false,
                    alive: true,
                    joinedAt: Date.now()
                });

                setMyMafiaId(playerId);
                setCurrentMafiaRoom(roomId);
                setMafiaScreen('room');
                addMafiaSystemMessage(roomId, `${myMafiaNick}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
            };

            // ë§ˆí”¼ì•„ ë°© ë‚˜ê°€ê¸°
            const leaveMafiaRoom = async () => {
                if (!currentMafiaRoom) return;

                const room = mafiaRooms[currentMafiaRoom];
                await db.ref(`mafia/rooms/${currentMafiaRoom}/players/${myMafiaId}`).remove();
                
                if (room.host === myMafiaId) {
                    const remainingPlayers = Object.keys(room.players || {}).filter(id => id !== myMafiaId);
                    if (remainingPlayers.length > 0) {
                        await db.ref(`mafia/rooms/${currentMafiaRoom}/host`).set(remainingPlayers[0]);
                    } else {
                        await db.ref(`mafia/rooms/${currentMafiaRoom}`).remove();
                    }
                }

                addMafiaSystemMessage(currentMafiaRoom, `${myMafiaNick}ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.`);
                setCurrentMafiaRoom(null);
                setMyMafiaId('');
                setMafiaScreen('lobby');
            };

            // ì¤€ë¹„
            const toggleMafiaReady = async () => {
                const room = mafiaRooms[currentMafiaRoom];
                const isReady = room.players[myMafiaId].ready;
                await db.ref(`mafia/rooms/${currentMafiaRoom}/players/${myMafiaId}/ready`).set(!isReady);
            };

            // ê²Œì„ ì‹œì‘
            const startMafiaGame = async () => {
                const room = mafiaRooms[currentMafiaRoom];
                const players = Object.entries(room.players);
                
                if (players.length < 4) {
                    alert('ìµœì†Œ 4ëª… ì´ìƒì´ì–´ì•¼ ê²Œì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
                    return;
                }

                const allReady = players.every(([id, p]) => p.ready || id === room.host);
                if (!allReady) {
                    alert('ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì¤€ë¹„í•´ì•¼ í•©ë‹ˆë‹¤!');
                    return;
                }

                // ì—­í•  ë°°ì •
                const roles = getRoleDistribution(players.length);
                const shuffledRoles = shuffle(roles);
                
                const updates = {};
                players.forEach(([id], index) => {
                    updates[`mafia/rooms/${currentMafiaRoom}/players/${id}/role`] = shuffledRoles[index];
                    updates[`mafia/rooms/${currentMafiaRoom}/players/${id}/alive`] = true;
                });

                updates[`mafia/rooms/${currentMafiaRoom}/phase`] = MAFIA_PHASES.DAY;
                updates[`mafia/rooms/${currentMafiaRoom}/day`] = 1;
                updates[`mafia/rooms/${currentMafiaRoom}/phaseEndTime`] = Date.now() + 90000; // 90ì´ˆ
                updates[`mafia/rooms/${currentMafiaRoom}/winner`] = null;

                await db.ref().update(updates);
                
                // ì—­í•  ê³µì§€
                const roleCount = {};
                shuffledRoles.forEach(r => {
                    roleCount[r] = (roleCount[r] || 0) + 1;
                });
                const roleMsg = Object.entries(roleCount)
                    .map(([role, count]) => `${MAFIA_ROLES[role].emoji}${MAFIA_ROLES[role].name} ${count}ëª…`)
                    .join(', ');
                
                addMafiaSystemMessage(currentMafiaRoom, `ğŸ® ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! (${roleMsg})`);
                addMafiaSystemMessage(currentMafiaRoom, 'â˜€ï¸ 1ì¼ì°¨ ë‚®ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. ììœ ë¡­ê²Œ ëŒ€í™”í•˜ì„¸ìš”! (90ì´ˆ)');
            };

            // ë°°ì—´ ì„ê¸°
            const shuffle = (array) => {
                const arr = [...array];
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            };

            // í˜ì´ì¦ˆ ì¢…ë£Œ ì²˜ë¦¬ (ìë™)
            const handleMafiaPhaseEnd = async () => {
                const room = mafiaRooms[currentMafiaRoom];
                if (!room) return;

                // ë°©ì¥ë§Œ í˜ì´ì¦ˆ ì „í™˜ ì²˜ë¦¬
                if (room.host !== myMafiaId) return;

                if (room.phase === MAFIA_PHASES.DAY) {
                    // ë‚® -> íˆ¬í‘œ
                    await db.ref(`mafia/rooms/${currentMafiaRoom}`).update({
                        phase: MAFIA_PHASES.VOTE,
                        phaseEndTime: Date.now() + 40000, // 40ì´ˆ
                        votes: {}
                    });
                    addMafiaSystemMessage(currentMafiaRoom, 'ğŸ—³ï¸ íˆ¬í‘œ ì‹œê°„ì…ë‹ˆë‹¤! ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ì‚¬ëŒì—ê²Œ íˆ¬í‘œí•˜ì„¸ìš”! (40ì´ˆ)');
                    
                } else if (room.phase === MAFIA_PHASES.VOTE) {
                    // íˆ¬í‘œ -> ë°¤
                    await processMafiaVotes();
                    
                } else if (room.phase === MAFIA_PHASES.NIGHT) {
                    // ë°¤ -> ë‚®
                    await processMafiaNight();
                }
            };

            // íˆ¬í‘œ ì²˜ë¦¬
            const processMafiaVotes = async () => {
                const room = mafiaRooms[currentMafiaRoom];
                const votes = room.votes || {};
                
                const voteCount = {};
                Object.values(votes).forEach(targetId => {
                    voteCount[targetId] = (voteCount[targetId] || 0) + 1;
                });

                let maxVotes = 0;
                let executed = null;
                Object.entries(voteCount).forEach(([playerId, count]) => {
                    if (count > maxVotes) {
                        maxVotes = count;
                        executed = playerId;
                    }
                });

                if (executed && maxVotes > 0) {
                    await db.ref(`mafia/rooms/${currentMafiaRoom}/players/${executed}/alive`).set(false);
                    const executedPlayer = room.players[executed];
                    addMafiaSystemMessage(currentMafiaRoom, 
                        `ğŸ’€ íˆ¬í‘œ ê²°ê³¼ ${executedPlayer.nickname}ë‹˜ì´ ì²˜í˜•ë˜ì—ˆìŠµë‹ˆë‹¤. ` +
                        `ì—­í• : ${MAFIA_ROLES[executedPlayer.role].emoji} ${MAFIA_ROLES[executedPlayer.role].name}`
                    );
                } else {
                    addMafiaSystemMessage(currentMafiaRoom, 'âš–ï¸ íˆ¬í‘œê°€ ë¬´ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë¬´ë„ ì²˜í˜•ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }

                const gameEnded = await checkMafiaGameEnd();
                if (!gameEnded) {
                    await db.ref(`mafia/rooms/${currentMafiaRoom}`).update({
                        phase: MAFIA_PHASES.NIGHT,
                        phaseEndTime: Date.now() + 50000, // 50ì´ˆ
                        nightActions: {}
                    });
                    addMafiaSystemMessage(currentMafiaRoom, 'ğŸŒ™ ë°¤ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ˆí”¼ì•„ì™€ íŠ¹ìˆ˜ ì§ì—…ì€ ëŠ¥ë ¥ì„ ì‚¬ìš©í•˜ì„¸ìš”! (50ì´ˆ)');
                }
            };

            // ë°¤ ì²˜ë¦¬
            const processMafiaNight = async () => {
                const room = mafiaRooms[currentMafiaRoom];
                const actions = room.nightActions || {};
                
                let killed = actions.mafia;
                const saved = actions.doctor;
                const investigated = actions.police;

                // ì˜ì‚¬ê°€ êµ¬ì¶œ
                if (killed && killed === saved) {
                    addMafiaSystemMessage(currentMafiaRoom, 'âš•ï¸ ì˜ì‚¬ê°€ ëˆ„êµ°ê°€ë¥¼ ì‚´ë ¸ìŠµë‹ˆë‹¤!');
                    killed = null;
                }

                // ë§ˆí”¼ì•„ ì‚´í•´
                if (killed) {
                    await db.ref(`mafia/rooms/${currentMafiaRoom}/players/${killed}/alive`).set(false);
                    const killedPlayer = room.players[killed];
                    addMafiaSystemMessage(currentMafiaRoom, 
                        `ğŸ’€ ${killedPlayer.nickname}ë‹˜ì´ ë§ˆí”¼ì•„ì—ê²Œ ì‚´í•´ë‹¹í–ˆìŠµë‹ˆë‹¤.`
                    );
                }

                // ê²½ì°° ì¡°ì‚¬ ê²°ê³¼ (ê°œì¸ ë©”ì‹œì§€)
                if (investigated) {
                    const target = room.players[investigated];
                    const policeIds = Object.entries(room.players)
                        .filter(([id, p]) => p.role === 'POLICE' && p.alive)
                        .map(([id]) => id);
                    
                    policeIds.forEach(policeId => {
                        const isMafia = target.role === 'MAFIA';
                        addMafiaPrivateMessage(currentMafiaRoom, policeId, 
                            `ğŸ” ì¡°ì‚¬ ê²°ê³¼: ${target.nickname}ë‹˜ì€ ${isMafia ? 'ğŸ”ª ë§ˆí”¼ì•„ì…ë‹ˆë‹¤!' : 'âœ… ë§ˆí”¼ì•„ê°€ ì•„ë‹™ë‹ˆë‹¤.'}`
                        );
                    });
                }

                const gameEnded = await checkMafiaGameEnd();
                if (!gameEnded) {
                    const newDay = (room.day || 1) + 1;
                    await db.ref(`mafia/rooms/${currentMafiaRoom}`).update({
                        phase: MAFIA_PHASES.DAY,
                        day: newDay,
                        phaseEndTime: Date.now() + 90000 // 90ì´ˆ
                    });
                    addMafiaSystemMessage(currentMafiaRoom, `â˜€ï¸ ${newDay}ì¼ì°¨ ë‚®ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. ììœ ë¡­ê²Œ ëŒ€í™”í•˜ì„¸ìš”! (90ì´ˆ)`);
                }
            };

            // ê²Œì„ ì¢…ë£Œ í™•ì¸
            const checkMafiaGameEnd = async () => {
                const room = mafiaRooms[currentMafiaRoom];
                if (!room) return false;

                const alivePlayers = Object.entries(room.players).filter(([_, p]) => p.alive);
                const aliveMafia = alivePlayers.filter(([_, p]) => p.role === 'MAFIA');
                const aliveCitizens = alivePlayers.filter(([_, p]) => p.role !== 'MAFIA');

                if (aliveMafia.length === 0) {
                    await db.ref(`mafia/rooms/${currentMafiaRoom}`).update({
                        phase: MAFIA_PHASES.WAITING,
                        winner: 'CITIZEN',
                        phaseEndTime: null
                    });
                    addMafiaSystemMessage(currentMafiaRoom, 'ğŸ‰ ê²Œì„ ì¢…ë£Œ! ì‹œë¯¼íŒ€ ìŠ¹ë¦¬! ëª¨ë“  ë§ˆí”¼ì•„ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    return true;
                }

                if (aliveMafia.length >= aliveCitizens.length) {
                    await db.ref(`mafia/rooms/${currentMafiaRoom}`).update({
                        phase: MAFIA_PHASES.WAITING,
                        winner: 'MAFIA',
                        phaseEndTime: null
                    });
                    addMafiaSystemMessage(currentMafiaRoom, 'ğŸ”ª ê²Œì„ ì¢…ë£Œ! ë§ˆí”¼ì•„íŒ€ ìŠ¹ë¦¬! ë§ˆí”¼ì•„ê°€ ì‹œë¯¼ì„ ì¥ì•…í–ˆìŠµë‹ˆë‹¤!');
                    return true;
                }

                return false;
            };

            // íˆ¬í‘œí•˜ê¸°
            const voteMafiaPlayer = async (targetId) => {
                await db.ref(`mafia/rooms/${currentMafiaRoom}/votes/${myMafiaId}`).set(targetId);
                setMafiaSelectedPlayer('');
                const targetNick = mafiaRooms[currentMafiaRoom].players[targetId].nickname;
                addMafiaSystemMessage(currentMafiaRoom, `${myMafiaNick}ë‹˜ì´ íˆ¬í‘œí–ˆìŠµë‹ˆë‹¤.`);
            };

            // ë°¤ ëŠ¥ë ¥ ì‚¬ìš©
            const useMafiaNightAbility = async (targetId) => {
                const room = mafiaRooms[currentMafiaRoom];
                const myRole = room.players[myMafiaId].role;
                const targetNick = room.players[targetId].nickname;
                
                if (myRole === 'MAFIA') {
                    await db.ref(`mafia/rooms/${currentMafiaRoom}/nightActions/mafia`).set(targetId);
                    addMafiaSystemMessage(currentMafiaRoom, 'ë§ˆí”¼ì•„ê°€ ëŒ€ìƒì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤...');
                } else if (myRole === 'DOCTOR') {
                    await db.ref(`mafia/rooms/${currentMafiaRoom}/nightActions/doctor`).set(targetId);
                    addMafiaSystemMessage(currentMafiaRoom, 'ì˜ì‚¬ê°€ ëˆ„êµ°ê°€ë¥¼ ë³´í˜¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
                } else if (myRole === 'POLICE') {
                    await db.ref(`mafia/rooms/${currentMafiaRoom}/nightActions/police`).set(targetId);
                    addMafiaSystemMessage(currentMafiaRoom, 'ê²½ì°°ì´ ì¡°ì‚¬ë¥¼ ì§„í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
                }
                setMafiaSelectedPlayer('');
            };

            // ë§ˆí”¼ì•„ ì±„íŒ…
            const sendMafiaMessage = async () => {
                if (!mafiaChatInput.trim()) return;
                
                const room = mafiaRooms[currentMafiaRoom];
                const me = room.players[myMafiaId];
                
                // ë°¤ì—ëŠ” ì±„íŒ… ê¸ˆì§€ (ë§ˆí”¼ì•„ë¼ë¦¬ë§Œ ê°€ëŠ¥í•˜ê²Œ í•  ìˆ˜ë„ ìˆìŒ)
                if (room.phase === MAFIA_PHASES.NIGHT && me.role !== 'MAFIA') {
                    alert('ë°¤ì—ëŠ” ì±„íŒ…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                    return;
                }

                await db.ref(`mafia/rooms/${currentMafiaRoom}/messages`).push({
                    player: myMafiaNick,
                    playerId: myMafiaId,
                    text: mafiaChatInput,
                    isMafia: me.role === 'MAFIA' && room.phase === MAFIA_PHASES.NIGHT,
                    timestamp: Date.now()
                });

                setMafiaChatInput('');
            };

            const addMafiaSystemMessage = async (roomId, text) => {
                await db.ref(`mafia/rooms/${roomId}/messages`).push({
                    system: true,
                    text: text,
                    timestamp: Date.now()
                });
            };

            const addMafiaPrivateMessage = async (roomId, playerId, text) => {
                await db.ref(`mafia/rooms/${roomId}/messages`).push({
                    private: true,
                    targetId: playerId,
                    text: text,
                    timestamp: Date.now()
                });
            };

            return (
                <div className="container">
                    <div className="header">
                        <h1>ğŸ­ ìµëª… ê²Œì‹œíŒ + ë§ˆí”¼ì•„ ê²Œì„</h1>
                    </div>

                    <div className="tabs">
                        <button className={`tab ${tab === 'mafia' ? 'active' : ''}`} onClick={() => setTab('mafia')}>
                            ğŸ­ ë§ˆí”¼ì•„
                        </button>
                        <button className={`tab ${tab === 'board' ? 'active' : ''}`} onClick={() => setTab('board')}>
                            ğŸ“ ê²Œì‹œíŒ
                        </button>
                        <button className={`tab ${tab === 'chat' ? 'active' : ''}`} onClick={() => setTab('chat')}>
                            ğŸ’¬ ì±„íŒ…
                        </button>
                    </div>

                    {tab === 'mafia' && (
                        <div>
                            {mafiaScreen === 'lobby' ? (
                                <>
                                    <div className="card">
                                        <h2 style={{marginBottom: '20px'}}>ğŸ® ìƒˆ ë°© ë§Œë“¤ê¸°</h2>
                                        <input
                                            type="text"
                                            value={myMafiaNick}
                                            onChange={(e) => setMyMafiaNick(e.target.value)}
                                            placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
                                            maxLength={10}
                                        />
                                        <input
                                            type="text"
                                            value={newMafiaRoomName}
                                            onChange={(e) => setNewMafiaRoomName(e.target.value)}
                                            placeholder="ë°© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                                            maxLength={20}
                                        />
                                        <select value={newMafiaRoomMax} onChange={(e) => setNewMafiaRoomMax(e.target.value)}>
                                            <option value={4}>4ëª…</option>
                                            <option value={6}>6ëª…</option>
                                            <option value={8}>8ëª…</option>
                                            <option value={10}>10ëª…</option>
                                            <option value={12}>12ëª…</option>
                                        </select>
                                        <button className="btn" onClick={createMafiaRoom}>ë°© ë§Œë“¤ê¸°</button>
                                    </div>

                                    <div className="card">
                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                                            <h2>ğŸ“‹ ë°© ëª©ë¡ ({Object.keys(mafiaRooms).length}ê°œ)</h2>
                                            <button 
                                                className="btn btn-small" 
                                                onClick={() => setShowMafiaRules(!showMafiaRules)}
                                                style={{background: '#9b59b6'}}
                                            >
                                                {showMafiaRules ? 'ê·œì¹™ ìˆ¨ê¸°ê¸°' : 'ğŸ“– ê²Œì„ ê·œì¹™'}
                                            </button>
                                        </div>
                                        
                                        {showMafiaRules && (
                                            <div className="mafia-rules">
                                                <h3>ğŸ­ ê²Œì„ ê·œì¹™ ë° ì—­í•  ì•ˆë‚´</h3>
                                                
                                                <div className="info-box">
                                                    <h4 style={{marginBottom: '10px'}}>ğŸ‘¥ ì¸ì›ë³„ ì—­í•  ë°°ì •</h4>
                                                    <ul>
                                                        <li><strong>4-5ëª…:</strong> ë§ˆí”¼ì•„ 1ëª…, ê²½ì°° 1ëª…, ì‹œë¯¼</li>
                                                        <li><strong>6-7ëª…:</strong> ë§ˆí”¼ì•„ 2ëª…, ê²½ì°° 1ëª…, ì˜ì‚¬ 1ëª…, ì‹œë¯¼</li>
                                                        <li><strong>8-9ëª…:</strong> ë§ˆí”¼ì•„ 2ëª…, ê²½ì°° 1ëª…, ì˜ì‚¬ 1ëª…, ì‹œë¯¼</li>
                                                        <li><strong>10-11ëª…:</strong> ë§ˆí”¼ì•„ 3ëª…, ê²½ì°° 1ëª…, ì˜ì‚¬ 1ëª…, ì‹œë¯¼</li>
                                                        <li><strong>12ëª…+:</strong> ë§ˆí”¼ì•„ 3ëª…, ê²½ì°° 2ëª…, ì˜ì‚¬ 1ëª…, ì‹œë¯¼</li>
                                                    </ul>
                                                </div>

                                                <div className="info-box">
                                                    <h4 style={{marginBottom: '10px'}}>ğŸ­ ì—­í• ë³„ ëŠ¥ë ¥</h4>
                                                    <p><strong>ğŸ”ª ë§ˆí”¼ì•„:</strong> ë°¤ì— ì‹œë¯¼ í•œ ëª…ì„ ì œê±°í•©ë‹ˆë‹¤. ë™ë£Œ ë§ˆí”¼ì•„ë¥¼ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                                    <p><strong>ğŸ‘¤ ì‹œë¯¼:</strong> íŠ¹ìˆ˜ ëŠ¥ë ¥ì€ ì—†ì§€ë§Œ í† ë¡ ê³¼ íˆ¬í‘œë¡œ ë§ˆí”¼ì•„ë¥¼ ì°¾ì•„ëƒ…ë‹ˆë‹¤.</p>
                                                    <p><strong>âš•ï¸ ì˜ì‚¬:</strong> ë°¤ì— í•œ ëª…ì„ ì„ íƒí•˜ì—¬ ë§ˆí”¼ì•„ì˜ ê³µê²©ìœ¼ë¡œë¶€í„° ë³´í˜¸í•©ë‹ˆë‹¤.</p>
                                                    <p><strong>ğŸ‘® ê²½ì°°:</strong> ë°¤ì— í•œ ëª…ì„ ì¡°ì‚¬í•˜ì—¬ ë§ˆí”¼ì•„ ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                                </div>

                                                <div className="warning-box">
                                                    <h4 style={{marginBottom: '10px'}}>â° ê²Œì„ ì§„í–‰ (ìë™)</h4>
                                                    <p><strong>â˜€ï¸ ë‚® (90ì´ˆ):</strong> ììœ ë¡­ê²Œ í† ë¡ í•˜ê³  ì˜ì‹¬ê°€ëŠ” ì‚¬ëŒì„ ì°¾ìŠµë‹ˆë‹¤.</p>
                                                    <p><strong>ğŸ—³ï¸ íˆ¬í‘œ (40ì´ˆ):</strong> ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ì‚¬ëŒì—ê²Œ íˆ¬í‘œí•©ë‹ˆë‹¤. ìµœë‹¤ ë“í‘œìê°€ ì²˜í˜•ë©ë‹ˆë‹¤.</p>
                                                    <p><strong>ğŸŒ™ ë°¤ (50ì´ˆ):</strong> ë§ˆí”¼ì•„ëŠ” ì œê±°í•  ì‚¬ëŒì„, ì˜ì‚¬ëŠ” ë³´í˜¸í•  ì‚¬ëŒì„, ê²½ì°°ì€ ì¡°ì‚¬í•  ì‚¬ëŒì„ ì„ íƒí•©ë‹ˆë‹¤.</p>
                                                    <p style={{marginTop: '10px', fontWeight: 'bold', color: '#e74c3c'}}>* ì‹œê°„ì´ ëë‚˜ë©´ ìë™ìœ¼ë¡œ ë‹¤ìŒ í˜ì´ì¦ˆë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤!</p>
                                                </div>

                                                <div className="danger-box">
                                                    <h4 style={{marginBottom: '10px'}}>ğŸ† ìŠ¹ë¦¬ ì¡°ê±´</h4>
                                                    <p><strong>ì‹œë¯¼íŒ€ ìŠ¹ë¦¬:</strong> ëª¨ë“  ë§ˆí”¼ì•„ë¥¼ ì œê±°í•˜ë©´ ìŠ¹ë¦¬!</p>
                                                    <p><strong>ë§ˆí”¼ì•„íŒ€ ìŠ¹ë¦¬:</strong> ë§ˆí”¼ì•„ ìˆ˜ â‰¥ ì‹œë¯¼ ìˆ˜ê°€ ë˜ë©´ ìŠ¹ë¦¬!</p>
                                                </div>

                                                <div className="info-box">
                                                    <h4 style={{marginBottom: '10px'}}>ğŸ’¡ ê²Œì„ íŒ</h4>
                                                    <p>â€¢ ë‚®ì—ëŠ” ì ê·¹ì ìœ¼ë¡œ ì˜ê²¬ì„ ë‚˜ëˆ„ê³  ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í–‰ë™ì„ ê´€ì°°í•˜ì„¸ìš”.</p>
                                                    <p>â€¢ ë§ˆí”¼ì•„ëŠ” ë™ë£Œë¥¼ ë³´í˜¸í•˜ë©´ì„œ ì‹œë¯¼ì¸ ì²™ ì—°ê¸°í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                                                    <p>â€¢ ê²½ì°°ê³¼ ì˜ì‚¬ëŠ” ìì‹ ì˜ ì •ì²´ë¥¼ ë„ˆë¬´ ì¼ì° ë°íˆì§€ ë§ˆì„¸ìš”.</p>
                                                    <p>â€¢ íˆ¬í‘œëŠ” ì‹ ì¤‘í•˜ê²Œ! ì˜ëª»ëœ íˆ¬í‘œëŠ” ì‹œë¯¼íŒ€ì—ê²Œ ë¶ˆë¦¬í•©ë‹ˆë‹¤.</p>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {Object.keys(mafiaRooms).length === 0 ? (
                                            <p style={{textAlign: 'center', opacity: 0.7, padding: '40px'}}>
                                                ì•„ì§ ìƒì„±ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ë°©ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!
                                            </p>
                                        ) : (
                                            <div className="mafia-room-list">
                                                {Object.entries(mafiaRooms).map(([roomId, room]) => (
                                                    <div key={roomId} className="mafia-room-card" onClick={() => joinMafiaRoom(roomId)}>
                                                        <div className="mafia-room-header">{room.name}</div>
                                                        <div style={{fontSize: '0.9rem', opacity: 0.9}}>
                                                            ë°©ì¥: {room.players[room.host]?.nickname}
                                                        </div>
                                                        <div className="mafia-room-info">
                                                            <span>ğŸ‘¥ {Object.keys(room.players || {}).length}/{room.maxPlayers}ëª…</span>
                                                            <span>{room.phase === MAFIA_PHASES.WAITING ? 'â¸ï¸ ëŒ€ê¸°ì¤‘' : 'ğŸ® ê²Œì„ì¤‘'}</span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </>
                            ) : (
                                // ê²Œì„ ë°©
                                (() => {
                                    const room = mafiaRooms[currentMafiaRoom];
                                    if (!room) return null;

                                    const isHost = room.host === myMafiaId;
                                    const me = room.players[myMafiaId];
                                    const alivePlayers = Object.entries(room.players).filter(([_, p]) => p.alive);
                                    const myRole = me?.role ? MAFIA_ROLES[me.role] : null;
                                    const canAct = me?.alive && room.phase !== MAFIA_PHASES.WAITING;

                                    return (
                                        <div>
                                            <div className="card" style={{background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white'}}>
                                                <h1 style={{marginBottom: '10px'}}>ğŸ­ {room.name}</h1>
                                                <p>ë°©ì¥: {room.players[room.host]?.nickname} | ì°¸ê°€ì: {Object.keys(room.players).length}/{room.maxPlayers}ëª…</p>
                                            </div>

                                            {room.winner && (
                                                <div className={`mafia-result ${room.winner === 'MAFIA' ? 'result-mafia-win' : 'result-citizen-win'}`}>
                                                    {room.winner === 'MAFIA' ? 'ğŸ”ª ë§ˆí”¼ì•„íŒ€ ìŠ¹ë¦¬!' : 'ğŸ‰ ì‹œë¯¼íŒ€ ìŠ¹ë¦¬!'}
                                                    <div style={{fontSize: '1.2rem', marginTop: '15px'}}>
                                                        ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤
                                                    </div>
                                                </div>
                                            )}

                                            {room.phase !== MAFIA_PHASES.WAITING && (
                                                <>
                                                    <div className={`mafia-phase phase-${room.phase}`}>
                                                        {room.phase === MAFIA_PHASES.DAY && `â˜€ï¸ ${room.day}ì¼ì°¨ ë‚®`}
                                                        {room.phase === MAFIA_PHASES.VOTE && 'ğŸ—³ï¸ íˆ¬í‘œ ì‹œê°„'}
                                                        {room.phase === MAFIA_PHASES.NIGHT && 'ğŸŒ™ ë°¤'}
                                                    </div>
                                                    
                                                    <div className="mafia-timer">
                                                        â±ï¸ {Math.floor(mafiaTimeLeft / 60)}:{String(mafiaTimeLeft % 60).padStart(2, '0')}
                                                    </div>
                                                </>
                                            )}

                                            {room.phase === MAFIA_PHASES.WAITING && (
                                                <div className="mafia-phase phase-waiting">
                                                    â¸ï¸ ê²Œì„ ëŒ€ê¸°ì¤‘
                                                </div>
                                            )}

                                            {myRole && (
                                                <div className="card" style={{background: '#e3f2fd', border: '2px solid #2196f3'}}>
                                                    <h2 style={{marginBottom: '10px', color: '#1976d2'}}>ğŸ­ ë‹¹ì‹ ì˜ ì—­í• </h2>
                                                    <div style={{fontSize: '2.5rem', textAlign: 'center', margin: '15px 0'}}>
                                                        {myRole.emoji} {myRole.name}
                                                    </div>
                                                    <p style={{textAlign: 'center', color: '#555', fontSize: '1.1rem'}}>
                                                        {myRole.description}
                                                    </p>
                                                    {me.role === 'MAFIA' && (
                                                        <div className="danger-box" style={{marginTop: '15px'}}>
                                                            <p><strong>ë™ë£Œ ë§ˆí”¼ì•„:</strong> {
                                                                Object.entries(room.players)
                                                                    .filter(([id, p]) => p.role === 'MAFIA' && id !== myMafiaId)
                                                                    .map(([_, p]) => p.nickname).join(', ') || 'ì—†ìŒ (í˜¼ìì…ë‹ˆë‹¤!)'
                                                            }</p>
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            <div className="card">
                                                <h2 style={{marginBottom: '15px'}}>
                                                    ğŸ‘¥ í”Œë ˆì´ì–´ ({alivePlayers.length}ëª… ìƒì¡´ / {Object.keys(room.players).length}ëª…)
                                                </h2>
                                                <div className="mafia-player-grid">
                                                    {Object.entries(room.players).map(([playerId, player]) => {
                                                        const isMe = playerId === myMafiaId;
                                                        const isSelected = mafiaSelectedPlayer === playerId;
                                                        const canSelect = canAct && player.alive && !isMe && 
                                                            ((room.phase === MAFIA_PHASES.VOTE) || 
                                                             (room.phase === MAFIA_PHASES.NIGHT && me.role !== 'CITIZEN'));

                                                        return (
                                                            <div
                                                                key={playerId}
                                                                className={`mafia-player-card ${!player.alive ? 'dead' : ''} ${isSelected ? 'selected' : ''} ${isMe ? 'me' : ''}`}
                                                                onClick={() => canSelect && setMafiaSelectedPlayer(isSelected ? '' : playerId)}
                                                                style={{cursor: canSelect ? 'pointer' : 'default'}}
                                                            >
                                                                <div style={{fontSize: '2rem', marginBottom: '8px'}}>
                                                                    {player.alive ? 'ğŸ˜Š' : 'ğŸ’€'}
                                                                </div>
                                                                <div style={{fontWeight: 'bold', marginBottom: '5px', fontSize: '1rem'}}>
                                                                    {player.nickname}
                                                                    {isMe && ' (ë‚˜)'}
                                                                </div>
                                                                <div style={{fontSize: '0.85rem', opacity: 0.7}}>
                                                                    {player.alive ? 'âœ… ìƒì¡´' : 'âŒ ì‚¬ë§'}
                                                                </div>
                                                                {!player.alive && player.role && (
                                                                    <div className={`mafia-role-badge ${MAFIA_ROLES[player.role].color}`}>
                                                                        {MAFIA_ROLES[player.role].emoji} {MAFIA_ROLES[player.role].name}
                                                                    </div>
                                                                )}
                                                                {room.phase === MAFIA_PHASES.WAITING && !isHost && (
                                                                    <div style={{marginTop: '8px', fontSize: '0.9rem'}}>
                                                                        {player.ready ? 'âœ… ì¤€ë¹„' : 'â¸ï¸ ëŒ€ê¸°'}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>

                                                {mafiaSelectedPlayer && (
                                                    <div style={{marginTop: '20px'}}>
                                                        {room.phase === MAFIA_PHASES.VOTE && (
                                                            <button className="btn btn-danger" onClick={() => voteMafiaPlayer(mafiaSelectedPlayer)}>
                                                                ğŸ—³ï¸ {room.players[mafiaSelectedPlayer].nickname}ë‹˜ì—ê²Œ íˆ¬í‘œí•˜ê¸°
                                                            </button>
                                                        )}
                                                        {room.phase === MAFIA_PHASES.NIGHT && me.role !== 'CITIZEN' && (
                                                            <button 
                                                                className="btn" 
                                                                onClick={() => useMafiaNightAbility(mafiaSelectedPlayer)}
                                                                style={{background: me.role === 'MAFIA' ? '#e74c3c' : me.role === 'DOCTOR' ? '#2ecc71' : '#f39c12'}}
                                                            >
                                                                {me.role === 'MAFIA' && `ğŸ”ª ${room.players[mafiaSelectedPlayer].nickname}ë‹˜ ì œê±°`}
                                                                {me.role === 'DOCTOR' && `âš•ï¸ ${room.players[mafiaSelectedPlayer].nickname}ë‹˜ ë³´í˜¸`}
                                                                {me.role === 'POLICE' && `ğŸ” ${room.players[mafiaSelectedPlayer].nickname}ë‹˜ ì¡°ì‚¬`}
                                                            </button>
                                                        )}
                                                    </div>
                                                )}
                                            </div>

                                            <div className="card">
                                                <h2 style={{marginBottom: '15px'}}>ğŸ’¬ ì±„íŒ…</h2>
                                                <div className="mafia-chat" ref={mafiaChatRef}>
                                                    {mafiaMessages.map((msg) => {
                                                        if (msg.private && msg.targetId !== myMafiaId) return null;
                                                        if (msg.isMafia && me.role !== 'MAFIA') return null;
                                                        
                                                        return (
                                                            <div key={msg.id} className={`mafia-message ${msg.system ? 'system' : ''} ${msg.private ? 'private' : ''}`}>
                                                                {msg.system ? (
                                                                    <div style={{fontWeight: 'bold'}}>{msg.text}</div>
                                                                ) : msg.private ? (
                                                                    <>
                                                                        <div className="mafia-message-header">ğŸ”’ ë¹„ë°€ ë©”ì‹œì§€</div>
                                                                        <div>{msg.text}</div>
                                                                    </>
                                                                ) : (
                                                                    <>
                                                                        <div className="mafia-message-header">
                                                                            {msg.isMafia && 'ğŸ”ª [ë§ˆí”¼ì•„] '}
                                                                            {msg.player}
                                                                        </div>
                                                                        <div>{msg.text}</div>
                                                                    </>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                                
                                                {me?.alive && (room.phase !== MAFIA_PHASES.NIGHT || me.role === 'MAFIA') && (
                                                    <div style={{display: 'flex', gap: '10px'}}>
                                                        <input
                                                            type="text"
                                                            value={mafiaChatInput}
                                                            onChange={(e) => setMafiaChatInput(e.target.value)}
                                                            onKeyPress={(e) => e.key === 'Enter' && sendMafiaMessage()}
                                                            placeholder={me.role === 'MAFIA' && room.phase === MAFIA_PHASES.NIGHT ? 
                                                                "ë§ˆí”¼ì•„ë¼ë¦¬ ëŒ€í™”..." : "ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."}
                                                            style={{flex: 1, marginBottom: 0}}
                                                        />
                                                        <button className="btn" onClick={sendMafiaMessage} style={{width: 'auto', padding: '12px 25px'}}>
                                                            ì „ì†¡
                                                        </button>
                                                    </div>
                                                )}
                                                {room.phase === MAFIA_PHASES.NIGHT && me?.alive && me.role !== 'MAFIA' && (
                                                    <p style={{textAlign: 'center', color: '#999', fontStyle: 'italic'}}>
                                                        ë°¤ì—ëŠ” ì±„íŒ…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤...
                                                    </p>
                                                )}
                                            </div>

                                            <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                                {room.phase === MAFIA_PHASES.WAITING && (
                                                    <>
                                                        {isHost ? (
                                                            <button className="btn btn-success" onClick={startMafiaGame}>
                                                                ğŸ® ê²Œì„ ì‹œì‘
                                                            </button>
                                                        ) : (
                                                            <button 
                                                                className="btn" 
                                                                onClick={toggleMafiaReady}
                                                                style={{background: me?.ready ? '#95a5a6' : '#3498db'}}
                                                            >
                                                                {me?.ready ? 'âœ… ì¤€ë¹„ ì·¨ì†Œ' : 'â¸ï¸ ì¤€ë¹„í•˜ê¸°'}
                                                            </button>
                                                        )}
                                                    </>
                                                )}
                                                <button className="btn btn-danger" onClick={leaveMafiaRoom}>
                                                    ğŸšª ë°© ë‚˜ê°€ê¸°
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })()
                            )}
                        </div>
                    )}

                    {tab === 'board' && (
                        <div className="card">
                            <h2>ğŸ“ ê²Œì‹œíŒ</h2>
                            <p style={{textAlign: 'center', padding: '40px', opacity: 0.7}}>
                                ê²Œì‹œíŒ ê¸°ëŠ¥ì€ ì›ë³¸ íŒŒì¼ì„ ì°¸ê³ í•˜ì„¸ìš”
                            </p>
                        </div>
                    )}

                    {tab === 'chat' && (
                        <div className="card">
                            <h2>ğŸ’¬ ì±„íŒ…</h2>
                            <p style={{textAlign: 'center', padding: '40px', opacity: 0.7}}>
                                ì±„íŒ… ê¸°ëŠ¥ì€ ì›ë³¸ íŒŒì¼ì„ ì°¸ê³ í•˜ì„¸ìš”
                            </p>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
